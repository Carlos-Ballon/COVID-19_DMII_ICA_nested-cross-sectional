---
title: "Risk factors associated with COVID-19 mortality in patients with type 2 diabetes - Nested Cross-Sectional"
author: "Carlos Ballon-Salcedo & Kevin J. Paez"
date: "`r Sys.Date()`"
format: 
  html:
    theme: 
     light: lux
     dark: darkly
    toc: true
    toc-depth: 4
    code-overflow: wrap
    code-fold: true
    highlight-style: github
    code-tools: 
      source: "https://github.com/Carlos-Ballon/COVID-19_DMII_ICA_nested-cross-sectional"
    include-in-header:
      - file: zoom_in_out.js
editor: source
editor_options: 
  chunk_output_type: inline
bibliography: grateful-refs.bib
csl: vancouver.csl
---

::: {style="text-align: justify"}
A clear plan for a data analysis and visualization project must optimize resource allocation. The typical steps to carry out these projects in R are as follows: data import, data manipulation, descriptive statistics, inferential statistics and data visualization.
:::

# Set global knitr options

```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Load packages

```{r}
# Packages
pacman::p_load(
  rio,
  here,
  reportfactory,
  rfextras,
  tidyverse,
  ggcorrplot,
  ggsci,
  ggpubr,
  ggthemes,
  ggpomological,
  extrafont,
  showtext,
  finalfit,
  gtsummary,
  flextable,
  ftExtra,
  broom,
  performance,
  lmtest,
  stats,
  moments,
  nortest,
  epiDisplay,
  car,
  ResourceSelection,
  Rtsne,
  factoextra,
  corrplot,
  grateful,
  patchwork,
  officer,
  magick
  )

# For PostScript output
# extrafont::loadfonts(device = "postscript")

# My function scripts
rfextras::load_scripts()
```

```{r eval=FALSE}
grateful::cite_packages(
  output = "file",
  out.format = "docx",
  out.dir = ".",
  citation.style = "vancouver")
```

# Import data

```{r}
clean_data <- import(here("data", "data.csv"))
```

# Set themes

::: {style="text-align: justify"}
The custom themes for `gtsummary`, `flextable`, and `ggplot2`, are in the `custom themes.R` script. The only theme that needs to be set is the `gtsummary` theme.
:::

```{r}
# Set a gtsummary theme
gtsummary::theme_gtsummary_compact()
gtsummary::theme_gtsummary_journal(journal = "jama")

# Set a gtsummary language
gtsummary::theme_gtsummary_language(language = "en")
```

# Process data

## Remove missing values (\>10% by variable)

```{r}
clean_data <- clean_data |>
  dplyr::select(where( ~ sum(is.na(.)) < 90))
```

::: {style="text-align: justify"}
The following variables were removed: mcv, mch, hemoglobin, hematocrit, creatinine, urea, glucose, ph, anion_gap, sodio, potasio, cloro, calcio, fi_o2, PCO2, HCO3, lactate, antiparasitic.
:::

## Matching

The match will be with a 1:3 ratio match.

```{r}
# Matching for Causal Inference
data <- MatchIt::matchit(
  I(t2dm == "yes") ~ edad,
  data = clean_data,
  exact = ~ sex,
  caliper = c(edad = 3),
  std.caliper = T,
  distance = "euclidean",
  ratio = 3
)

# Construct a matched dataset from a matchit object
data_match_eda <- MatchIt::match.data(data, subclass = "matched_id")
```

## Recode and relevel (dictionary)

::: {style="text-align: justify"}
This subsection converts categorical variables into factors and recode/clean values using a data dictionary. The categorical variables will be saved as factor vectors, while some continuous/numeric variables will be categorized and converted into factors. Then, recode and change the factor levels using the `forcats` package. Also, the `finalfit` package will be utilized to label variables, while the `ftExtra` package will detect special characters and format the character columns as markdown text to be added to the flextable object. An alternate option is to utilize the `matchmaker` package for dictionary-based cleanup or `labelled` package to manipulate metadata. The disadvantage of categorizing continuous variables is that information is discarded. To address this, repeat the analysis on continuous variables to ensure there are no differences in the conclusion (sensitivity analysis).
:::

> üìù***NOTE:*** The markdown texts is by design a plain text

### Exposures and outcomes

::: {style="text-align: justify"}
Potential risk factors associated with mortality caused by COVID-19 in patients with type II diabetes mellitus (T2DM) are presented, each factor/variable is labeled with a legend that indicates its clinical importance, accuracy, and number of events. This is see in the **dictionary** script.
:::

-   Clinically important with enough evidence but with small number of events, shown as `####`
-   Clinically important with enough evidence and enough number of events, shown as `###`
-   Clinically important with limited evidence, shown as `##`
-   Inconsistent or contradictory evidence and unconfirmed accuracy (self-reported) `#`

```{r}
data_match_eda <- dictionary(data_match_eda)
```

## Exploratory Data Analysis (EDA)

::: {style="text-align: justify"}
In this subsection we will see a preview of the descriptive statistics, some summary measures from our sample. How you visualize the distribution of a variable will depend on whether the variable is categorical or continuous. To analyze the distribution of a continuous variable, begin with a histogram or density plot for a visual representation of the data distribution. For categorical variables, a bar chart or a pie/donut chart provides a clear comparison of different categories. In cases where a categorical variable has few levels, consider using tables or boxplots for a more concise display of the data.
:::

> üìù***NOTE:*** Descriptive statistics help you describe your current data, while inferential statistics allow you to make predictions and informed decisions based on your data.

### Categorical variables

::: {style="text-align: justify"}
A categorical variable is a variable that can take on one of a small set of values. These values can be character, logical, or factor values. According to the object classes, character class objects are the most flexible, while logic class objects are the most restrictive. Many categorical variables lack an intrinsic order, and thus, it is necessary to reorder them to create a more informative display.
:::

```{r}
# Factor selection
categorical <- data_match_eda |>
  dplyr::select(where(is.factor), -matched_id)
```

```{r eval=FALSE}
# Multiple tables (relative frequencies) with lapply
lapply(categorical, function(x)
  round(prop.table(table(x)) * 100, 1))
```

#### Relative frequencies with tidyr and dplyr

```{r}
categorical_pivot <- categorical |>
  tidyr::pivot_longer(everything(), names_to = "Variable", values_to = "Valor") |>
  dplyr::group_by(Variable, Valor) |>
  dplyr::summarise(n = n()) |>
  tidyr::drop_na() |>
  dplyr::mutate(perc = round(n / sum(n) * 100, 1))
```

```{r}
# Variables with relative frequency less than 2.5%
excluded_var <- categorical_pivot |>
  dplyr::filter(perc < 2.5) |>
  dplyr::distinct(Variable) |>
  dplyr::pull()
```

```{r eval=FALSE}
# Multiple tables by T2DM
lapply(categorical, function(x)
  table(x, categorical$t2dm))
```

### Numerical variables

::: {style="text-align: justify"}
The distribution of continuous/numeric variables can be visualized using histograms, frequency polygons, Q-Q plots, box plots, violin plots, jitter plots, and Sina plots. A variable is considered continuous if it can assume any value from an infinite set of ordered values within an interval. A histogram shows the distribution of a continuous variable and differs from a bar chart by grouping data into continuous intervals. It also examines the distribution of a continuous variable broken down by a categorical variable (categorical outcome). A density plot displays the density instead of the count, which is the standardized count so that the area under each frequency polygon is 1 or 100%. In addition to the histogram and the frequency polygon, the probability distribution of a continuous variable can be obtained from the **density function**. This function is defined in terms of probability and would construct a frequency polygon if we had an infinite set of data, resulting in a continuous curve.
:::

```{r results='hide'}
# Selection of numerical variables
numerical <- data_match_eda |>
  dplyr::select(where(is.numeric))

# Summary statistics
lapply(numerical, function(x)
  summary(x))
```

```{r}
# Variable groups
dem_numerical <- numerical |>
  dplyr::select(edad:DBP, platelets, -t_enfermedad)

hemo_numerical <- numerical |>
  dplyr::select(WBC:NLR)

gas_numerical <- numerical |>
  dplyr::select(SaO2:PaO2)
```

::: panel-tabset

#### Part 1 {.active}

```{r fig.height=11, fig.width=11.5, fig.align='center'}
# Formal and visual exploration
total_plots(dem_numerical)
```

#### Part 2

```{r fig.height=8, fig.width=10, fig.align='center'}
# Formal and visual exploration
total_plots(hemo_numerical)
```

#### Part 3

```{r fig.height=8, fig.width=10, fig.align='center'}
# Formal and visual exploration
total_plots(gas_numerical)
```

:::

### Numerical variables in patients with T2DM

::: {style="text-align: justify"}
In this part, density plots will be used to illustrate the data grouped by the outcome. Other plots will not be included in the analysis, as a table with more detailed information will be presented. The questions we will ask ourselves are: Does the data appear to be normally distributed? and are the variances between groups equal?
:::

```{r}
# Selection of numerical variables of patients with T2DM
surv_numerical_t2dm <- data_match_eda |>
  dplyr::select(where(is.numeric), outcome, t2dm) |>
  dplyr::filter(t2dm == "yes")
```

```{r eval=FALSE}
# Summary statistics of T2DM patients
lapply(surv_numerical_t2dm, function(x)
  summary(x))
```

::: panel-tabset

#### Part 1

```{r fig.height=15, fig.width=18, fig.align = 'center'}
# Exploration of age by group
p1 <- group_stat_table_plot(surv_numerical_t2dm, "edad", "outcome")

# Exploration of frec_respiratoria by group
p2 <- group_stat_table_plot(surv_numerical_t2dm, "frec_respiratoria", "outcome")

# Exploration of frec_cardiaca by group
p3 <- group_stat_table_plot(surv_numerical_t2dm, "frec_cardiaca", "outcome")

# Exploration of sick time by group
p4 <- group_stat_table_plot(surv_numerical_t2dm, "t_enfermedad", "outcome")

p1 + p2 + p3 + p4 + plot_annotation(
  title = 'Patients with T2DM',
  theme = theme(plot.title = element_text(size = 35, family = "Syne", hjust = 0.5),
                plot.background = element_rect(fill = "#f0f0f0", color = NA)))
```

#### Part 2

```{r fig.height=15, fig.width=18, fig.align = 'center'}
# Exploration of SBP by group
p1 <- group_stat_table_plot(surv_numerical_t2dm, "SBP", "outcome")

# Exploration of DBP by group
p2 <- group_stat_table_plot(surv_numerical_t2dm, "DBP", "outcome")

# Exploration of platelets by group
p3 <- group_stat_table_plot(surv_numerical_t2dm, "platelets", "outcome")

# Exploration of length of stay by group
p4 <- group_stat_table_plot(surv_numerical_t2dm, "len_hosp_stay", "outcome")

p1 + p2 + p3 + p4 + plot_annotation(
  title = 'Patients with T2DM',
  theme = theme(plot.title = element_text(size = 35, family = "Syne", hjust = 0.5),
                plot.background = element_rect(fill = "#f0f0f0", color = NA)))
```

#### Part 3

```{r fig.height=15, fig.width=18, fig.align = 'center'}
# Exploration of WBC by group
p1 <- group_stat_table_plot(surv_numerical_t2dm, "WBC", "outcome")

# Exploration of NLR by group
p2 <- group_stat_table_plot(surv_numerical_t2dm, "NLR", "outcome")

# Exploration of neutrophils by group
p3 <- group_stat_table_plot(surv_numerical_t2dm, "neutrofilos", "outcome")

# Exploration of lymphocytes by group
p4 <- group_stat_table_plot(surv_numerical_t2dm, "linfocitos", "outcome")

p1 + p2 + p3 + p4 + plot_annotation(
  title = 'Patients with T2DM',
  theme = theme(plot.title = element_text(size = 35, family = "Syne", hjust = 0.5),
                plot.background = element_rect(fill = "#f0f0f0", color = NA)))
```

#### Part 4

```{r fig.height=15, fig.width=18, fig.align = 'center'}
# Exploration of PaO2:FiO2 by group
p1 <- group_stat_table_plot(surv_numerical_t2dm, "PaO2_FiO2", "outcome")

# Exploration of PaO2 by group
p2 <- group_stat_table_plot(surv_numerical_t2dm, "PaO2", "outcome")

# Exploration of FiO2 by group
p3 <- group_stat_table_plot(surv_numerical_t2dm, "FiO2", "outcome")

# Exploration of SaO2s by group
p4 <- group_stat_table_plot(surv_numerical_t2dm, "SaO2", "outcome")

p1 + p2 + p3 + p4 + plot_annotation(
  title = 'Patients with T2DM',
  theme = theme(plot.title = element_text(size = 35, family = "Syne", hjust = 0.5),
                plot.background = element_rect(fill = "#f0f0f0", color = NA)))
```

:::

### Numerical variables in patients without T2DM

```{r}
# Selection of numerical variables of patients without T2DM
non_numerical_not2dm <- data_match_eda |>
  dplyr::select(where(is.numeric), outcome, t2dm) |>
  dplyr::filter(t2dm == "no")
```

```{r eval=FALSE}
# Summary statistics of non-T2DM patients
lapply(non_numerical_not2dm, function(x)
  summary(x))
```

::: panel-tabset

#### Part 1

```{r fig.height=15, fig.width=18, fig.align = 'center'}
# Exploration of age by group
p1 <- group_stat_table_plot(non_numerical_not2dm, "edad", "outcome")

# Exploration of frec_respiratoria by group
p2 <- group_stat_table_plot(non_numerical_not2dm, "frec_respiratoria", "outcome")

# Exploration of frec_cardiaca by group
p3 <- group_stat_table_plot(non_numerical_not2dm, "frec_cardiaca", "outcome")

# Exploration of sick time by group
p4 <- group_stat_table_plot(non_numerical_not2dm, "t_enfermedad", "outcome")

p1 + p2 + p3 + p4 + plot_annotation(
  title = 'Patients without T2DM',
  theme = theme(plot.title = element_text(size = 35, family = "Syne", hjust = 0.5),
                plot.background = element_rect(fill = "#f0f0f0", color = NA)))
```

#### Part 2

```{r fig.height=15, fig.width=18, fig.align = 'center'}
# Exploration of SBP by group
p1 <- group_stat_table_plot(non_numerical_not2dm, "SBP", "outcome")

# Exploration of DBP by group
p2 <- group_stat_table_plot(non_numerical_not2dm, "DBP", "outcome")

# Exploration of platelets by group
p3 <- group_stat_table_plot(non_numerical_not2dm, "platelets", "outcome")

# Exploration of length of stay by group
p4 <- group_stat_table_plot(non_numerical_not2dm, "len_hosp_stay", "outcome")

p1 + p2 + p3 + p4 + plot_annotation(
  title = 'Patients without T2DM',
  theme = theme(plot.title = element_text(size = 35, family = "Syne", hjust = 0.5),
                plot.background = element_rect(fill = "#f0f0f0", color = NA)))
```

#### Part 3

```{r fig.height=15, fig.width=18, fig.align = 'center'}
# Exploration of WBC by group
p1 <- group_stat_table_plot(non_numerical_not2dm, "WBC", "outcome")

# Exploration of NLR by group
p2 <- group_stat_table_plot(non_numerical_not2dm, "NLR", "outcome")

# Exploration of neutrophils by group
p3 <- group_stat_table_plot(non_numerical_not2dm, "neutrofilos", "outcome")

# Exploration of lymphocytes by group
p4 <- group_stat_table_plot(non_numerical_not2dm, "linfocitos", "outcome")

p1 + p2 + p3 + p4 + plot_annotation(
  title = 'Patients without T2DM',
  theme = theme(plot.title = element_text(size = 35, family = "Syne", hjust = 0.5),
                plot.background = element_rect(fill = "#f0f0f0", color = NA)))
```

#### Part 4

```{r fig.height=15, fig.width=18, fig.align = 'center'}
# Exploration of PaO2:FiO2 by group
p1 <- group_stat_table_plot(non_numerical_not2dm, "PaO2_FiO2", "outcome")

# Exploration of PaO2 by group
p2 <- group_stat_table_plot(non_numerical_not2dm, "PaO2", "outcome")

# Exploration of FiO2 by group
p3 <- group_stat_table_plot(non_numerical_not2dm, "FiO2", "outcome")

# Exploration of SaO2 by group
p4 <- group_stat_table_plot(non_numerical_not2dm, "SaO2", "outcome")

p1 + p2 + p3 + p4 + plot_annotation(
  title = 'Patients without T2DM',
  theme = theme(plot.title = element_text(size = 35, family = "Syne", hjust = 0.5),
                plot.background = element_rect(fill = "#f0f0f0", color = NA)))
```

:::

### Correlation matrix (multicollinearity)

::: {style="text-align: justify"}
The correlation between independent variables will be explored in order to identify multicollinearity.
:::

> üìù***NOTE:*** ggplot objects can't process markdown text

```{r fig.height=9, fig.width=9, fig.align='center'}
# Selection of numerical variables
data_num = data_match_eda |>
  dplyr::select(where(is.numeric), -weights, -pafi_cal) |>
  na.omit()

# Rename variables
cor_data = rename(
  data_num,
  "Age" = edad,
  "Respiratory rate" = frec_respiratoria,
  "Heart rate" = frec_cardiaca,
  "SBP" = SBP,
  "DBP" = DBP,
  "WBC" = WBC,
  "Neutrophils" = neutrofilos,
  "Lymphocytes" = linfocitos,
  "NLR" = NLR,
  "Platelets" = platelets,
  "SaO2" = SaO2,
  "FiO2" = FiO2,
  "PaO2:FiO2 ratio" = PaO2_FiO2,
  "PaO2" = PaO2,
  "Follow-up time (days)" = len_hosp_stay,
  "Sick time (days)" = t_enfermedad
)

# Correlation matrix
corr <- round(cor(cor_data), 1)

# Color visualization
FS1 <- my_ggcorrplor(corr)

# View
FS1

# Gray visualization
FS1_grey <- my_ggcorrplor_grey(corr)
```

::: {style="text-align: justify"}
With the exception of WBC and the PaO~2~:FiO~2~ ratio, the numerical variables are independent of each other. In the case of using  white-cells and neutrophils or lymphocytes, it is possible that this information may become redundant and generate biased estimates. The same occurs with the PaO~2~:FiO~2~ ratio and the FiO~2~ or PaO~2~; given the clinical relevance of the PaO~2~:FiO~2~ ratio, it is preferable to work only with the latter.
:::

# Produce outputs

## Variable selection to analyze

::: {style="text-align: justify"}
The variables with not enough events (\<2.5%) were excluded from the analysis. These were alcoholism, antibiotics, asma_bronquial, cancer, disf_multiorg, dislip, ecv, epc, erc, f_hepatica_aguda, f_multiorganica, hemodialisis, hiv, immunsupressive_dis, perdida_de_peso, polidipysia, polifagia, poliuria, sensorio, and smoker. The variables ac_renal_failure, sepsis and shock_septico were also excluded due to possible misclassification bias.
:::

```{r}
# Select included variables
data_match <- var_selec_analysis(data_match_eda)
```

```{r}
# Check included variables
included_var <- colnames(data_match)

# Check excluded variables
dplyr::setdiff(excluded_var, included_var)
# unique(excluded_var, included_var)
```

## Table 1. Demographic and clinical characteristics of patients

```{r}
# Demographic characteristics and clinical history
tbl_1.1 <- data_match |>
  tbl_summary(
    include = c(edad:len_hosp_stay),
    by = t2dm,
    percent = "column",
    statistic = list(edad ~ "{mean} ({sd})"),
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_overall() |>
  add_p(edad ~ "t.test",
        test.args = edad ~ list(var.equal = TRUE)) |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})",
                stat_0 = "**All patients** (n = {N})",
                p.value = "**p value**") |>
  modify_spanning_header(c(stat_1, stat_2) ~ "**Type 2 Diabetes**")

# Signs and symptoms
tbl_1.2 <- data_match |>
  tbl_summary(
    include = c(fever:dolor_abdominal, t2dm),
    by = t2dm,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_overall() |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")

# Vital signs
tbl_1.3 <- data_match |>
  tbl_summary(
    include = c(frec_respiratoria:DBP, t2dm),
    by = t2dm,
    percent = "column",
    statistic = list(frec_cardiaca ~ "{mean} ({sd})"),
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_overall() |>
  add_p(frec_cardiaca ~ "t.test",
        test.args = frec_cardiaca ~ list(var.equal = TRUE)) |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")
```

```{r}
# Stack tables
table_1 = tbl_stack(
  list(tbl_1.1, tbl_1.2, tbl_1.3),
  group_header = c(
    "Demographic characteristics and clinical history",
    "Signs and symtoms",
    "Vital signs"
  ),
  quiet = TRUE
  ) |>
  modify_caption(
    "**Table 1**. Demographic and clinical characteristics of the patients"
    )

# Convert gtsummary object to a flextable object and format character columns
flex_table_1 <- table_1 |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
table_1
```

## Table 2. Laboratory findings and treatment of patients

```{r}
# Laboratory findings
tbl_2.1 <- data_match |>
  tbl_summary(
    include = c(WBC:platelets.c, t2dm),
    by = t2dm,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_overall() |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})",
                stat_0 = "**All patients** (n = {N})",
                p.value = "**p value**") |>
  modify_spanning_header(all_stat_cols(stat_0 = FALSE) ~ "**Type 2 Diabetes**")

# Blood gas findings
tbl_2.2 <- data_match |>
  tbl_summary(
    include = c(SaO2:PaO2.c, t2dm),
    by = t2dm,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_overall() |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")

# Treatments
tbl_2.3 <- data_match |>
  tbl_summary(
    include = c(corticoides:pronacion, t2dm),
    by = t2dm,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_overall() |>
  add_p() |>
  bold_p(t = 0.05) |> 
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")
```

```{r}
# Stack tables
table_2 = tbl_stack(
  list(tbl_2.1, tbl_2.2, tbl_2.3),
  group_header = c("Laboratory findings", "Blood gas findings", "Treatment"),
  quiet = TRUE
) |>
  modify_caption("Table 2. Laboratory findings and treatment of patients")

# Convert gtsummary object to a flextable object and format character columns
flex_table_2 <- table_2 |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
flex_table_2
```

## Table 3. Demographic and clinical characteristics of patients by T2DM

### Patients with T2DM

```{r}
# Demographic characteristics and clinical history
tbl_3.1 <-
  data_match |> 
  dplyr::filter(t2dm == "yes") |>
  tbl_summary(
    include = c(edad:obesity, hta, outcome),
    by = outcome,
    percent = "column",
    statistic = list(edad ~ "{mean} ({sd})"),
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p(edad ~ "t.test",
        test.args = edad ~ list(var.equal = TRUE)) |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})",
                p.value = "**p value**")

# Signs and symptoms
tbl_3.2 <-
  data_match |> 
  dplyr::filter(t2dm == "yes") |>
  tbl_summary(
    include = c(fever:dolor_abdominal, outcome),
    by = outcome,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")

# Vital signs
tbl_3.3 <-
  data_match |> 
  dplyr::filter(t2dm == "yes") |>
  tbl_summary(
    include = c(frec_respiratoria:DBP.c, outcome),
    by = outcome,
    percent = "column",
    statistic = list(frec_cardiaca ~ "{mean} ({sd})"),
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p(frec_cardiaca ~ "t.test",
        test.args = frec_cardiaca ~ list(var.equal = TRUE)) |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")
```

### Patients without T2DM

```{r}
# Demographic characteristics and clinical history
tbl_3.4 <-
  data_match |>
  dplyr::filter(t2dm == "no") |>
  tbl_summary(
    include = c(edad:obesity, hta, outcome),
    by = outcome,
    percent = "column",
    statistic = list(edad ~ "{mean} ({sd})"),
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p(edad ~ "t.test", 
        test.args = edad ~ list(var.equal = FALSE)) |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})",
                p.value = "**p value**")

# Signs and symptoms
tbl_3.5 <-
  data_match |> 
  dplyr::filter(t2dm == "no") |>
  tbl_summary(
    include = c(fever:dolor_abdominal, outcome),
    by = outcome,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")

# Vital signs
tbl_3.6 <-
  data_match |> 
  dplyr::filter(t2dm == "no") |>
  tbl_summary(
    include = c(frec_respiratoria:DBP.c, outcome),
    by = outcome,
    percent = "column",
    statistic = list(frec_cardiaca ~ "{mean} ({sd})"),
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p(frec_cardiaca ~ "t.test",
        test.args = frec_cardiaca ~ list(var.equal = FALSE)) |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")
```

```{r}
# Merge tables
tbl_3_p1 <- tbl_merge(
  tbls = list(tbl_3.1, tbl_3.4),
  tab_spanner = c("**Patients with T2DM**", "**Patients without T2DM**")
)

tbl_3_p2 <- tbl_merge(tbls = list(tbl_3.2, tbl_3.5)) |>
  modify_spanning_header(everything() ~ NA_character_)

tbl_3_p3 <- tbl_merge(tbls = list(tbl_3.3, tbl_3.6)) |>
  modify_spanning_header(everything() ~ NA_character_)

# Stack tables
table_3 = tbl_stack(
  list(tbl_3_p1, tbl_3_p2, tbl_3_p3),
  group_header = c(
    "Demographic characteristics and clinical history",
    "Signs and symtoms",
    "Vital signs"
  ),
  quiet = TRUE
) |> 
  modify_caption(
    "**Table 3**. Demographic and clinical characteristics of the patients by T2DM")

# Convert gtsummary object to a flextable object and format character columns
flex_table_3 <- table_3 |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
table_3
```

## Table 4. Laboratory findings and treatment of patients by T2DM

### Patients with T2DM

```{r}
# Laboratory findings
tbl_4.1 <-
  data_match |> 
  dplyr::filter(t2dm == "yes") |>
  tbl_summary(
    include = c(WBC:platelets.c, outcome),
    by = outcome,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})",
                p.value = "**p value**")

# Blood gas findings
tbl_4.2 <-
  data_match |> 
  dplyr::filter(t2dm == "yes") |>
  tbl_summary(
    include = c(SaO2:PaO2.c, outcome),
    by = outcome,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")

# Treatment
tbl_4.3 <-
  data_match |> 
  dplyr::filter(t2dm == "yes") |>
  tbl_summary(
    include = c(corticoides:pronacion, outcome),
    by = outcome,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")
```

### Patients without T2DM

```{r}
# Laboratory findings
tbl_4.4 <-
  data_match |> 
  dplyr::filter(t2dm == "no") |>
  tbl_summary(
    include = c(WBC:platelets.c, outcome),
    by = outcome,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})",
                p.value = "**p value**")

# Blood gas findings
tbl_4.5 <-
  data_match |> 
  dplyr::filter(t2dm == "no") |>
  tbl_summary(
    include = c(SaO2:PaO2.c, outcome),
    by = outcome,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")

# Treatment
tbl_4.6 <-
  data_match |> 
  dplyr::filter(t2dm == "no") |>
  tbl_summary(
    include = c(corticoides:pronacion, outcome),
    by = outcome,
    percent = "column",
    digits = list(all_continuous() ~ c(1, 1))
  ) |>
  add_p() |>
  bold_p(t = 0.05) |>
  modify_header(all_stat_cols() ~ "**{level}** (n = {n})")
```

```{r}
# Merge tables
tbl_4_p1 <- tbl_merge(
  tbls = list(tbl_4.1, tbl_4.4),
  tab_spanner = c("**Patients with T2DM**", "**Patients without T2DM**")
)

tbl_4_p2 <- tbl_merge(tbls = list(tbl_4.2, tbl_4.5)) |>
  modify_spanning_header(everything() ~ NA_character_)

tbl_4_p3 <- tbl_merge(tbls = list(tbl_4.3, tbl_4.6)) |>
  modify_spanning_header(everything() ~ NA_character_)

# Stack tables
table_4 = tbl_stack(
  list(tbl_4_p1, tbl_4_p2, tbl_4_p3),
  group_header = c("Laboratory findings", "Blood gas findings", "Treatment"),
  quiet = TRUE
) |>
  modify_caption("Table 4. Laboratory findings and treatment of patients")


# Convert gtsummary object to a flextable object and format character columns
flex_table_4 <- table_4 |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
flex_table_4
```

## Table 5. Logistic regression

::: {style="text-align: justify"}
In the univariate analysis, variables that were self-reported or did not have enough events were eliminated; this will help to avoid *overfitting* in the subsequent multivariable analysis. Other variables such as sex, smoker, alcoholism, dislip, obesity, malestar_general, anosmia, disgeusia, emesis, diarrea, poliuria, polidipysia, sensorio, SBP, DBP, platelets.c, pafi_cal.c, antibiotics, corticoides, anticoagulantes, antipaludicos, pronacion, showed *no differences* between groups in the bivariate analysis (Tables 4 and 5).
:::

| Self-reported | Not enough event (\<10) |
|------------------------------------|------------------------------------|
| dolor_de_garganta, malestar_general, headache, anosmia, disgeusia, diarrea, emesis, astenia, dolor_abdominal, perdida_de_peso, sensorio, poliuria, polidipysia, polifagia. | smoker, alcoholism, dislip, ecv, cancer, hiv, immunsupressive_dis, erc, hemodialisis, asma_bronquial, epc, shock_septico, disf_multiorg, f_hepatica_aguda, f_multiorganica, perdida_de_peso, poliuria, polidipysia, polifagia, sensorio, antibiotics. |

: Not analyzed variables

```{r}
# Patients with T2DM
data_uv_dm <- var_selec_uv(data_match, "yes")

# Patients without T2DM
data_uv_nondm <- var_selec_uv(data_match, "no")
```

### Univariate models

> üìù***NOTE:*** The variables included in the univariate regression analysis were selected based on the results of the bivariate analysis.

#### Patients with T2DM

```{r}
table_s1.1_uv <- data_uv_dm |>
  tbl_uvregression(
    include = c(edad.c:pronacion),
    y = outcome,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      sex ~ "Sex",
      hta ~ "Hypertension",
      obesity ~ "Obesity",
      fever ~ "Fever",
      tos ~ "Dry cought",
      taquipnea ~ "Tachypnea",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      frec_respiratoria.c ~ "Respiratory rate (BPM)",
      SBP.c ~ "SBP (mmHg)",
      DBP.c ~ "DBP (mmHg)",
      WBC.c ~ "White-cells (√ó10^9^/L)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      linfocitos.c ~ "Lymphocytes (√ó10^9^/L)",
      NLR.c ~ "NLR",
      platelets.c ~ "Platelets (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      FiO2.c ~ "FiO~2~ (%)",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio",
      PaO2.c ~ "PaO~2~",
      corticoides ~ "Corticosteroids",
      anticoagulantes ~ "Anticoagulants",
      antipaludicos ~ "Antimalarials",
      pronacion ~ "Pronation"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Univariate OR**", p.value = "**p value**")
```

#### Patients without T2DM

```{r}
table_s1.2_uv <- data_uv_nondm |>
  tbl_uvregression(
    include = c(edad.c:pronacion),
    y = outcome,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      sex ~ "Sex",
      hta ~ "Hypertension",
      obesity ~ "Obesity",
      fever ~ "Fever",
      tos ~ "Dry cought",
      taquipnea ~ "Tachypnea",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      frec_respiratoria.c ~ "Respiratory rate (BPM)",
      SBP.c ~ "SBP (mmHg)",
      DBP.c ~ "DBP (mmHg)",
      WBC.c ~ "White-cells (√ó10^9^/L)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      linfocitos.c ~ "Lymphocytes (√ó10^9^/L)",
      NLR.c ~ "NLR",
      platelets.c ~ "Platelets (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      FiO2.c ~ "FiO~2~ (%)",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio",
      PaO2.c ~ "PaO~2~",
      corticoides ~ "Corticosteroids",
      anticoagulantes ~ "Anticoagulants",
      antipaludicos ~ "Antimalarials",
      pronacion ~ "Pronation"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Univariate OR**", p.value = "**p value**")
```

```{r}
# Stack tables
table_uv = tbl_merge(
  list(table_s1.1_uv, table_s1.2_uv),
  tab_spanner = c("**Patients with T2DM**", "**Patients without T2DM**"
  )
) |>
  modify_caption("Table S1. Univariate logistic regression by T2DM")

# Convert gtsummary object to a flextable object and format character columns
flex_table_s1 <- table_uv |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
flex_table_s1
```

### Multivariable models

#### Complete multivariable for patients with T2DM

```{r}
# T2DM model
full_multivariable_dm <- glm(
  outcome ~
    edad.c + sex + hta + obesity + fever + tos + taquipnea + disnea +
    frec_cardiaca.c + frec_respiratoria.c + SBP.c +
    DBP.c + WBC.c + neutrofilos.c + linfocitos.c + NLR.c +
    platelets.c + SaO2.c + FiO2.c + PaO2_FiO2.c + PaO2.c +
    corticoides + anticoagulantes + antipaludicos + pronacion,
  data = data_uv_dm,
  family = binomial(link = "logit")
) |>
  tbl_regression(
    exponentiate = TRUE,
    conf.int = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      sex ~ "Sex",
      hta ~ "Hypertension",
      obesity ~ "Obesity",
      fever ~ "Fever",
      tos ~ "Dry cought",
      taquipnea ~ "Tachypnea",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      frec_respiratoria.c ~ "Respiratory rate (BPM)",
      SBP.c ~ "SBP (mmHg)",
      DBP.c ~ "DBP (mmHg)",
      WBC.c ~ "White-cells (√ó10^9^/L)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      linfocitos.c ~ "Lymphocytes (√ó10^9^/L)",
      NLR.c ~ "NLR",
      platelets.c ~ "Platelets (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      FiO2.c ~ "FiO~2~ (%)",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio",
      PaO2.c ~ "PaO~2~",
      corticoides ~ "Corticosteroids",
      anticoagulantes ~ "Anticoagulants",
      antipaludicos ~ "Antimalarials",
      pronacion ~ "Pronation"
    )
  ) |>
  bold_p(t = 0.05) |>
  add_vif() |>
  modify_header(estimate = "**Multivariable OR**", 
                p.value = "**p value**", 
                aGVIF ~ "**aGVIF**")
```

```{r fig.height=10, fig.width=10, fig.align='center'}
# Model
m1_dm = glm(
  outcome ~
    edad.c + sex + hta + obesity + fever + tos + taquipnea + disnea +
    frec_cardiaca.c + frec_respiratoria.c + SBP.c +
    DBP.c + WBC.c + neutrofilos.c + linfocitos.c + NLR.c +
    platelets.c + SaO2.c + FiO2.c + PaO2_FiO2.c + PaO2.c +
    corticoides + anticoagulantes + antipaludicos + pronacion,
  data = data_uv_dm,
  family = binomial(link = "logit")
)

# Visual check of model assumptions
performance::check_model(m1_dm)

# Model performance
broom::glance(m1_dm)

# Indices of model performance
performance::model_performance(m1_dm)

# Check for multicollinearity
performance::check_collinearity(m1_dm, ci = NULL)
```

```{r}
# Model summary with LRT
epiDisplay::logistic.display(m1_dm, simplified = FALSE, crude = FALSE)
```

#### Complete multivariable for patients without T2DM

```{r}
# Non-T2DM model
full_multivariable_nondm <- glm(
  outcome ~
    edad.c + sex + hta + obesity + fever + tos + taquipnea + disnea +
    frec_cardiaca.c + frec_respiratoria.c + SBP.c +
    DBP.c + WBC.c + neutrofilos.c + linfocitos.c + NLR.c +
    platelets.c + SaO2.c + FiO2.c + PaO2_FiO2.c + PaO2.c +
    corticoides + anticoagulantes + antipaludicos + pronacion,
  data = data_uv_nondm,
  family = binomial(link = "logit")
) |>
  tbl_regression(
    exponentiate = TRUE,
    conf.int = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      sex ~ "Sex",
      hta ~ "Hypertension",
      obesity ~ "Obesity",
      fever ~ "Fever",
      tos ~ "Dry cought",
      taquipnea ~ "Tachypnea",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      frec_respiratoria.c ~ "Respiratory rate (BPM)",
      SBP.c ~ "SBP (mmHg)",
      DBP.c ~ "DBP (mmHg)",
      WBC.c ~ "White-cells (√ó10^9^/L)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      linfocitos.c ~ "Lymphocytes (√ó10^9^/L)",
      NLR.c ~ "NLR",
      platelets.c ~ "Platelets (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      FiO2.c ~ "FiO~2~ (%)",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio",
      PaO2.c ~ "PaO~2~",
      corticoides ~ "Corticosteroids",
      anticoagulantes ~ "Anticoagulants",
      antipaludicos ~ "Antimalarials",
      pronacion ~ "Pronation"
    )
  ) |>
  bold_p(t = 0.05) |>
  add_vif() |>
  modify_header(estimate = "**Multivariable OR**",
                p.value = "**p value**",
                aGVIF ~ "**aGVIF**")
```

```{r fig.height=10, fig.width=10, fig.align='center'}
m1_non = glm(
  outcome ~
    edad.c + sex + hta + obesity + fever + tos + taquipnea + disnea +
    frec_cardiaca.c + frec_respiratoria.c + SBP.c +
    DBP.c + WBC.c + neutrofilos.c + linfocitos.c + NLR.c +
    platelets.c + SaO2.c + FiO2.c + PaO2_FiO2.c + PaO2.c +
    corticoides + anticoagulantes + antipaludicos + pronacion,
  data = data_uv_nondm,
  family = binomial(link = "logit")
)

# Visual check of model assumptions
performance::check_model(m1_non)

# Model performance
broom::glance(m1_non)

# Indices of model performance
performance::model_performance(m1_non)

# Check for multicollinearity
performance::check_collinearity(m1_non, ci = NULL)
```

```{r}
# Model summary with LRT
epiDisplay::logistic.display(m1_non, simplified = FALSE, crude = FALSE)
```

```{r}
# Stack tables
table_mv = tbl_merge(
  tbls = list(
    table_s1.1_uv,
    full_multivariable_dm,
    table_s1.2_uv,
    full_multivariable_nondm
  )
) |>
  modify_spanning_header(
    c(estimate_1:aGVIF_2) ~ "**Patients with T2DM**",
    c(estimate_3:aGVIF_4) ~ "**Patients without T2DM**"
  ) |> 
  modify_footnote(everything() ~ NA, abbreviation = TRUE) |>
  modify_table_body( ~ .x |> arrange(row_type == "glance_statistic")) |>
  modify_footnote(
    c(estimate_1, estimate_2, estimate_3, estimate_4) ~ "OR = Odds Ratio",
    c(ci_1, ci_2, ci_3, ci_4) ~ "95% CI = 95% Confidence Interval",
    c(GVIF_2, GVIF_4) ~ "GVIF = Generalized Variance Inflation Factor",
    c(aGVIF_2, aGVIF_4) ~ "aGVIF = Adjusted GVIF or GVIF^[1/(2*df)]"
  )

# Convert gtsummary object to a flextable object and format character columns
flex_table_mv <- table_mv |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
flex_table_mv
```

#### Multivariate reduced: backward for patients with T2DM

```{r}
backward_dm <- m1_dm |>
  stats::step(direction = "backward", trace = FALSE)
```

```{r}
# Model summary
jtools::summ(backward_dm)
```

```{r fig.height=10, fig.width=10, fig.align='center'}
m2_dm <-
  glm(
    outcome ~ edad.c + hta + taquipnea + frec_cardiaca.c + DBP.c +
      neutrofilos.c + SaO2.c + PaO2.c + antipaludicos,
    family = binomial(link = "logit"),
    data = data_uv_dm
  )

# Visual check of model assumptions
performance::check_model(m2_dm)

# Model performance
broom::glance(m2_dm)

# Indices of model performance
performance::model_performance(m2_dm)

# Check for multicollinearity
performance::check_collinearity(m2_dm, ci = NULL)
```

```{r}
# Model summary
epiDisplay::logistic.display(m2_dm, simplified = FALSE, crude = FALSE)
```

#### Multivariate reduced: backward for patients without T2DM

```{r fig.height=10, fig.width=10, fig.align='center'}
backward_non <- m1_non |>
  stats::step(direction = "backward", trace = FALSE)
```

```{r}
# Model summary
jtools::summ(backward_non)
```

```{r fig.height=10, fig.width=10, fig.align='center'}
m2_non <-
  glm(
    outcome ~ edad.c + fever + tos + frec_cardiaca.c + SBP.c + 
      linfocitos.c + NLR.c + platelets.c + SaO2.c + FiO2.c + 
      PaO2_FiO2.c + PaO2.c + antipaludicos,
    family = binomial(link = "logit"),
    data = data_uv_nondm
  )

# Visual check of model assumptions
performance::check_model(m2_non)

# Model performance
broom::glance(m2_non)

# Indices of model performance
performance::model_performance(m2_non)

# Check for multicollinearity
performance::check_collinearity(m2_non, ci = NULL)
```

```{r}
# Model summary with LRT
epiDisplay::logistic.display(m2_non, simplified = FALSE, crude = FALSE)
```
> üìù***NOTE:*** The forward selection yielded the same results as the complete model

#### Parsimonious model for patients with T2DM

::: {style="text-align: justify"}
In these models, only those variables that were statistically significant in previous analyses or that are clinically relevant according to the available evidence will be included. In subsequent analyses, some of the following variables may be excluded due to the potential for multicollinearity and to avoid overfitting: SBP.c, p_a_diastolic.c, WBC.c, neutrofilos.c, lymphocytes.c, NLR.c, FiO2.c, and PaO2.c. The exclusion of fever and cough is based on the observation that these symptoms lack specificity and are commonly observed in the context of most infections.
:::

```{r fig.height=10, fig.width=10, fig.align='center'}
# Parsimonious formula
m3_dm <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = data_uv_dm
  )

# Visual check of model assumptions
performance::check_model(m3_dm)

# Model performance
broom::glance(m3_dm)

# Indices of model performance
performance::model_performance(m3_dm)

# Check for multicollinearity
performance::check_collinearity(m3_dm, ci = NULL)
```

```{r}
# Model summary with LRT
epiDisplay::logistic.display(m3_dm, simplified = FALSE, crude = FALSE)
```

#### Parsimonious model for patients without T2DM

```{r fig.height=10, fig.width=10, fig.align='center'}
m3_non <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + NLR.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = data_uv_nondm
  )

# Visual check of model assumptions
performance::check_model(m3_non)

# Model performance
broom::glance(m3_non)

# Indices of model performance
performance::model_performance(m3_non)

# Check for multicollinearity
performance::check_collinearity(m3_non, ci = NULL)
```

```{r}
# Model summary with LRT
epiDisplay::logistic.display(m3_non, simplified = FALSE, crude = FALSE)
```

#### Final model for patients with T2DM

```{r}
table_5.1_uv <- data_uv_dm |>
  tbl_uvregression(
    include = c(
      edad.c,
      hta,
      disnea,
      frec_cardiaca.c,
      neutrofilos.c,
      SaO2.c,
      PaO2_FiO2.c
    ),
    y = outcome,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Univariate OR**", p.value = "**p value**")
```

```{r}
table_5.1_mv <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = data_uv_dm
  ) |>
  tbl_regression(
    conf.int = TRUE,
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Multivariable OR**", p.value = "**p value** ")
```

#### Final model for patients without T2DM

```{r}
table_5.2_uv <- data_uv_nondm |>
  tbl_uvregression(
    include = c(
      edad.c,
      hta,
      disnea,
      frec_cardiaca.c,
      neutrofilos.c,
      SaO2.c,
      PaO2_FiO2.c
    ),
    y = outcome,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Univariate OR**", p.value = "**p value**")
```

```{r}
table_5.2_mv <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = data_uv_nondm
  ) |>
  tbl_regression(
    conf.int = TRUE,
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Multivariable OR**", p.value = "**p value** ")
```

```{r}
# Number of observations
count.dm <- nrow(data_uv_dm)
count.non <- nrow(data_uv_nondm)

# Merge tables
table_5 <-
  tbl_merge(tbls = list(table_5.1_uv, table_5.1_mv,
                        table_5.2_uv, table_5.2_mv)) |>
  modify_spanning_header(list(
    c(estimate_1:p.value_2) ~ "**Patients with T2DM** (N = {paste(count.dm)})",
    c(estimate_3:p.value_4) ~ "**Patients without T2DM** (N = {paste(count.non)})"
  )) |>
  modify_footnote(everything() ~ NA, abbreviation = TRUE) |>
  modify_footnote(
    c(estimate_1, estimate_2, estimate_3, estimate_4) ~ "OR = Odds Ratio",
    c(ci_1, ci_2, ci_3, ci_4) ~ "95% CI = 95% Confidence Interval"
  ) |>
  modify_caption("Table 5. Multivariable logistic regression by T2DM")

# Convert gtsummary object to a flextable object and format character columns
flex_table_5 <- table_5 |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
flex_table_5
```

### Model comparison

#### T2DM patient models

```{r}
# Compare performance of different models
compare_performance(m1_dm, m2_dm, m3_dm, verbose = FALSE)

# Radar plot to compare models
plot(compare_performance(m1_dm, m2_dm, m3_dm, rank = TRUE, verbose = FALSE))

# Likelihood Ratio Test (LRT for comparison)
lmtest::lrtest(m2_dm, m3_dm)
```

#### non-T2DM patient models

```{r}
# Compare performance of different models
compare_performance(m1_non, m2_non, m3_non, verbose = FALSE)

# Radar plot to compare models
plot(compare_performance(m1_non, m2_non, m3_non, rank = TRUE, verbose = FALSE))

# Likelihood Ratio Test (LRT for comparison)
lmtest::lrtest(m2_non, m3_non)
```

# Sensitivity analysis

::: {style="text-align: justify"}
In this section, we will conduct sensitivity analyses using different approaches. One approach will employ continuous predictors, while the other will eliminate outliers or influential observations. The focus will be on the differences in the magnitude of the coefficient between the analyses, rather than on the p-values.
:::

## Sensitivity to categorization of continuous data

::: {style="text-align: justify"}
This is a sensitivity analysis of the categorization of continuous data. To ensure that there are no differences in the conclusions, the analyses will be repeated with continuous data. Although the categorization of continuous variables results in the loss of information, it has the advantage of assuming linearity and being easily interpreted by the non-specialized public.
:::

```{r}
# Patients with T2DM
data_sens_dm <- var_selec_sens(data_match, t2dm, "yes")

# Patients without T2DM
data_sens_nondm <- var_selec_sens(data_match, t2dm, "no")
```

### Patients with T2DM

#### Univariate regression analysis

```{r}
table_sens_uv_dm <- data_sens_dm |>
  tbl_uvregression(
    include = c(edad:PaO2),
    y = outcome,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca ~ "Heart rate (BPM)",
      frec_respiratoria ~ "Respiratory rate (BPM)",
      SBP ~ "SBP (mmHg)",
      DBP ~ "DBP (mmHg)",
      WBC ~ "White-cells (√ó10^9^/L)",
      neutrofilos ~ "Neutrophils (√ó10^9^/L)",
      linfocitos ~ "Lymphocytes (√ó10^9^/L)",
      NLR ~ "NLR",
      platelets ~ "Platelets (√ó10^9^/L)",
      SaO2 ~ "SaO~2~",
      FiO2 ~ "FiO~2~ (%)",
      PaO2_FiO2 ~ "PaO~2~:FiO~2~ ratio",
      PaO2 ~ "PaO~2~"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Univariate OR**", p.value = "**p value**")
```

#### Multivariable regression analysis

```{r}
# Original model (final) of T2DM patients
final_model_dm <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = data_uv_dm
  )

# Alternative model
sens_model_dm <-
  glm(
    outcome ~ edad + hta + disnea + frec_cardiaca + neutrofilos +
      SaO2 + PaO2_FiO2,
    family = binomial(link = "logit"),
    data = data_sens_dm
  )
```

```{r}
# Comparison of the regression coefficients and their standard errors
car::compareCoefs(final_model_dm, sens_model_dm, pvals = TRUE)
```

```{r}
# Impact on the overall multiple degrees of freedom significance test
car::Anova(final_model_dm, type = 3, test.statistic = "LR")
car::Anova(sens_model_dm, type = 3, test.statistic = "LR")
```

```{r}
table_sens_mv_dm <-
  glm(
    outcome ~ edad + hta + disnea + frec_cardiaca + neutrofilos +
      SaO2 + PaO2_FiO2,
    family = binomial(link = "logit"),
    data = data_sens_dm
  ) |>
  tbl_regression(
    conf.int = TRUE,
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca ~ "Heart rate (BPM)",
      neutrofilos ~ "Neutrophils (√ó10^9^/L)",
      SaO2 ~ "SaO~2~",
      PaO2_FiO2 ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Multivariable OR**", p.value = "**p value** ")
```

### Patients without T2DM

#### Univariate regression analysis with continuous data

```{r}
table_sens_uv_non <- data_sens_nondm |>
  tbl_uvregression(
    include = c(edad:PaO2),
    y = outcome,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca ~ "Heart rate (BPM)",
      frec_respiratoria ~ "Respiratory rate (BPM)",
      SBP ~ "SBP (mmHg)",
      DBP ~ "DBP (mmHg)",
      WBC ~ "White-cells (√ó10^9^/L)",
      neutrofilos ~ "Neutrophils (√ó10^9^/L)",
      linfocitos ~ "Lymphocytes (√ó10^9^/L)",
      NLR ~ "NLR",
      platelets ~ "Platelets (√ó10^9^/L)",
      SaO2 ~ "SaO~2~",
      FiO2 ~ "FiO~2~ (%)",
      PaO2_FiO2 ~ "PaO~2~:FiO~2~ ratio",
      PaO2 ~ "PaO~2~"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Univariate OR**", p.value = "**p value**")
```

#### Multivariable regression analysis with continuous data

```{r}
# Original model (final) of non-2DM patients
final_model_non <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = data_uv_nondm
  )

# Alternative model
sens_model_non <-
  glm(
    outcome ~ edad + hta + disnea + frec_cardiaca + neutrofilos +
      SaO2 + PaO2_FiO2,
    family = binomial(link = "logit"),
    data = data_sens_nondm
  )
```

```{r}
# Comparison of the regression coefficients and their standard errors
car::compareCoefs(final_model_non, sens_model_non, pvals = TRUE)
```

```{r}
# Impact on the overall multiple degrees of freedom significance test
car::Anova(final_model_non, type = 3, test.statistic = "LR")
car::Anova(sens_model_non, type = 3, test.statistic = "LR")
```

```{r}

table_sens_mv_non <-
  glm(
    outcome ~ edad + hta + disnea + frec_cardiaca + neutrofilos +
      SaO2 + PaO2_FiO2,
    family = binomial(link = "logit"),
    data = data_sens_nondm
  ) |>
  tbl_regression(
    conf.int = TRUE,
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca ~ "Heart rate (BPM)",
      neutrofilos ~ "Neutrophils (√ó10^9^/L)",
      SaO2 ~ "SaO~2~",
      PaO2_FiO2 ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Multivariable OR**", p.value = "**p value** ")
```

```{r}
# Number of observations
counts.dm <- nrow(data_sens_dm)
counts.non <- nrow(data_sens_nondm)
```

```{r}
# Merge tables
table_s2 <-
  tbl_merge(tbls = list(
    table_sens_uv_dm,
    table_sens_mv_dm,
    table_sens_uv_non,
    table_sens_mv_non
  )) |>
  modify_spanning_header(list(
    c(estimate_1:p.value_2) ~ "**Patients with T2DM** (N = {paste(counts.dm)})",
    c(estimate_3:p.value_4) ~ "**Patients without T2DM** (N = {paste(counts.non)})"
  )) |>
  modify_footnote(everything() ~ NA, abbreviation = TRUE) |>
  modify_footnote(
    c(estimate_1, estimate_2, estimate_3, estimate_4) ~ "OR = Odds Ratio",
    c(ci_1, ci_2, ci_3, ci_4) ~ "95% CI = 95% Confidence Interval"
  ) |>
  modify_caption("Table S2. Sensitivity to categorization of continuous data")

# Convert gtsummary object to a flextable object and format character columns
flex_table_s2 <- table_s2 |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
flex_table_s2
```

## Sensitivity to outliers and influential observations

::: {style="text-align: justify"}
This is a sensitivity analysis of outliers and influential observations, which involves the removal of said observations, subsequent evaluation of the effects on the model, and finally, re-evaluation of the remaining observations.
:::

### Patients with T2DM

```{r}
# Original model (final) of T2DM patients
final_model_dm <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = data_uv_dm
  )
```

#### Outlier identification

```{r}
# Outlier test
car::outlierTest(final_model_dm, n.max = Inf)

# Extract Studentized residuals
rstudent.dm <- rstudent(final_model_dm)

# Use a numeric cutoff based on the outlier test 
outliers.dm <- rstudent.dm > 2
rstudent.dm[outliers.dm]
```

```{r}
# Identify outlier observations
data_uv_nondm[c("144"),
              c("edad.c",
                "hta",
                "disnea",
                "frec_cardiaca.c",
                "neutrofilos.c",
                "SaO2.c",
                "PaO2_FiO2.c")]
```

```{r fig.align='center'}
# Plot Studentized residuals vs. fitted values
car::residualPlots(
  final_model_dm,
  pch = 20,
  smooth = list(col = "tomato"),
  col = "gray65",
  fitted = TRUE,
  terms = ~ 1,
  tests = FALSE,
  quadratic = FALSE,
  type = "rstudent"
  )

# Highlight outliers
points(fitted(final_model_dm)[outliers.dm],
       rstudent.dm[outliers.dm],
       pch = 20,
       cex = 2)
abline(h = c(-2, 2), lty = 2)
```

#### Influential observations identification

```{r fig.height=7, fig.align='center'}
# Studentized residuals and hat values
car::influenceIndexPlot(
  final_model_dm,
  vars = c("Studentized", "hat"),
  id = TRUE,
  main = "Residuals and leverage")
```

```{r fig.align='center'}
# Cook‚Äôs distance
car::influenceIndexPlot(
  final_model_dm,
  vars = "Cook",
  id = TRUE,
  main = "Cook's distance")
```

```{r}
# Extract Cook‚Äôs distance
cook.dm <- cooks.distance(final_model_dm)

# Subjective cutoff from plot
sub.cook.dm <- cook.dm  > 0.03

# View the extreme Cook's distance values
cook.dm[sub.cook.dm]
```

```{r}
# Extract DFBetas
dfbetas.dm <- dfbetas(final_model_dm)
colnames(dfbetas.dm)

# Standard cutoff for DFBeta
sub.dfbetas.dm <- apply(abs(dfbetas.dm) > 0.2, 1, any)

# View the extreme DFBetas - a large matrix so not shown
# dfbetas.dm[sub.dfbetas.dm, ]
```

```{r, fig.align='center'}
par(mfrow = c(2, 4))
plot(dfbetas.dm[, "(Intercept)"], ylab = "Intercept")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.dm[, "edad.c>= 61"], ylab = "Age >= 61")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.dm[, "htaYes"], ylab = "Hypertension")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.dm[, "disneaYes"], ylab = "Dyspnea")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.dm[, "frec_cardiaca.c>= 100"], ylab = "Heart rate >= 100")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.dm[, "neutrofilos.c> 6.3"], ylab = "Neutrophils > 6.3")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.dm[, "SaO2.c< 90"], ylab = "SaO2 < 90")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.dm[, "PaO2_FiO2.c<= 200"], ylab = "PaO2:FiO2 ratio <= 200")
abline(h = c(-0.2, 0.2), lty = 2)
```

```{r}
# Put it all together
influential_obs.dm <- outliers.dm | sub.cook.dm | sub.dfbetas.dm
sum(influential_obs.dm)

# Identify influential observations
influential_obs.dm[influential_obs.dm]
```

```{r}
# Subset data
subdat_dm <- subset(data_uv_dm, !influential_obs.dm)
nrow(data_uv_dm)
nrow(subdat_dm)
```

```{r}
# Alternative model
sens_model_outlier_dm <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = subdat_dm
  )

# Model summary
jtools::summ(sens_model_outlier_dm)
```

```{r}
# Comparison of the regression coefficients and their standard errors
car::compareCoefs(final_model_dm, sens_model_outlier_dm, pvals = TRUE)
```

```{r}
# Impact on the overall multiple degrees of freedom significance test
car::Anova(final_model_dm, type = 3, test.statistic = "LR")
car::Anova(sens_model_outlier_dm, type = 3, test.statistic = "LR")
```

::: {style="text-align: justify"}
We removed dyspnea from subsequent analyzes due to overestimation of its regression coefficient and standard error.
::: 

#### Univariate regression analysis

```{r}
table_sens_outlier_uv_dm <- subdat_dm |>
  tbl_uvregression(
    include = c(edad.c, hta, frec_cardiaca.c, neutrofilos.c,
                SaO2.c, PaO2_FiO2.c),
    y = outcome,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      hta ~ "Hypertension",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Univariate OR**", p.value = "**p value**")
```

#### Multivariable regression analysis

```{r}
table_sens_outlier_mv_dm <-
  glm(
    outcome ~ edad.c + hta + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = subdat_dm
  ) |>
  tbl_regression(
    conf.int = TRUE,
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      hta ~ "Hypertension",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Multivariable OR**", p.value = "**p value** ")
```

### Patients without T2DM

```{r}
# Original model (final) of non-T2DM patients
final_model_non <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = data_uv_nondm
  )
```

#### Outlier identification

```{r}
# Outlier test
car::outlierTest(final_model_non, n.max = Inf)

# Extract Studentized residuals
rstudent.non <- rstudent(final_model_non)

# Extract Studentized residuals
rstudent.non <- rstudent(final_model_non)

# Use a numeric cutoff based on the outlier test
outliers.non <- rstudent.non > 2
rstudent.non[outliers.non]
```

```{r}
# Identify outlier observations
data_uv_nondm[c("560", "608"),
              c("edad.c",
                "hta",
                "disnea",
                "frec_cardiaca.c",
                "neutrofilos.c",
                "SaO2.c",
                "PaO2_FiO2.c")]
```

```{r fig.align='center'}
# Plot Studentized residuals vs. fitted values
car::residualPlots(
  final_model_non,
  pch = 20,
  smooth = list(col = "tomato"),
  col = "gray65",
  fitted = TRUE,
  terms = ~ 1,
  tests = FALSE,
  quadratic = FALSE,
  type = "rstudent"
  )

# Highlight outliers
points(fitted(final_model_non)[outliers.non],
       rstudent.non[outliers.non],
       pch = 20,
       cex = 2)
abline(h = c(-2, 2), lty = 2)
```

#### Influential observations identification

```{r fig.height=7, fig.align='center'}
# Studentized residuals and hat values
car::influenceIndexPlot(
  final_model_non,
  vars = c("Studentized", "hat"),
  id = TRUE,
  main = "Residuals and leverage")
```

```{r fig.align='center'}
# Cook‚Äôs distance
car::influenceIndexPlot(
  final_model_non,
  vars = "Cook",
  id = TRUE,
  main = "Cook's distance")
```

```{r}
# Extract Cook‚Äôs distance
cook.non <- cooks.distance(final_model_non)

# Subjective cutoff from figure
sub.cook.non <- cook.non > 0.015

# View the extreme Cook's distance values
cook.non[sub.cook.non]
```

```{r}
# Extract DFBetas
dfbetas.non <- dfbetas(final_model_non)
colnames(dfbetas.dm)

# Standard cutoff for DFBeta
sub.dfbetas.non <- apply(abs(dfbetas.non) > 0.2, 1, any)

# View the extreme DFBetas - a large matrix so not shown
# dfbetas.non[sub.dfbetas.non, ]
```

```{r, fig.align='center'}
par(mfrow = c(2, 4))
plot(dfbetas.non[, "(Intercept)"], ylab = "Intercept")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.non[, "htaYes"], ylab = "Hypertension")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.non[, "disneaYes"], ylab = "Dyspnea")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.non[, "frec_cardiaca.c>= 100"], ylab = "Heart rate >= 100")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.non[, "neutrofilos.c> 6.3"], ylab = "Neutrophils > 6.3")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.non[, "SaO2.c< 90"], ylab = "SaO2 < 90")
abline(h = c(-0.2, 0.2), lty = 2)
plot(dfbetas.non[, "PaO2_FiO2.c<= 200"], ylab = "PaO2:FiO2 ratio <= 200")
abline(h = c(-0.2, 0.2), lty = 2)
```

```{r}
# Put it all together
influential_obs.non <- outliers.non| sub.cook.non | sub.dfbetas.non
sum(influential_obs.non)

# Identify influential observations
influential_obs.non[influential_obs.non]
```

```{r}
# Subset data
subdat_non <- subset(data_uv_nondm, !influential_obs.non)
nrow(data_uv_nondm)
nrow(subdat_non)
```

```{r}
# Alternative model
sens_model_outlier_non <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = subdat_non
  )

# Model summary
jtools::summ(sens_model_outlier_non)
```

```{r}
# Comparison of the regression coefficients and their standard errors
car::compareCoefs(final_model_non, sens_model_outlier_non, pvals = TRUE)
```

```{r}
# Impact on the overall multiple degrees of freedom significance test
car::Anova(final_model_non, type = 3, test.statistic = ("LR"))
car::Anova(sens_model_outlier_non, type = 3, test.statistic = ("LR"))
```

#### Univariate regression analysis

```{r}
table_sens_outlier_uv_non <- subdat_non |>
  tbl_uvregression(
    include = c(edad.c, hta, disnea, frec_cardiaca.c, neutrofilos.c,
                SaO2.c, PaO2_FiO2.c),
    y = outcome,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Univariate OR**", p.value = "**p value**")
```

#### Multivariable regression analysis

```{r}
table_sens_outlier_mv_non <-
  glm(
    outcome ~ edad.c + hta + disnea + frec_cardiaca.c + neutrofilos.c +
      SaO2.c + PaO2_FiO2.c,
    family = binomial(link = "logit"),
    data = subdat_non
  ) |>
  tbl_regression(
    conf.int = TRUE,
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad.c ~ "Age (years)",
      hta ~ "Hypertension",
      disnea ~ "Dyspnea",
      frec_cardiaca.c ~ "Heart rate (BPM)",
      neutrofilos.c ~ "Neutrophils (√ó10^9^/L)",
      SaO2.c ~ "SaO~2~",
      PaO2_FiO2.c ~ "PaO~2~:FiO~2~ ratio"
    )
  ) |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**Multivariable OR**", p.value = "**p value** ")
```

```{r}
# Number of observations
counts.dm <- nrow(subdat_dm)
counts.non <- nrow(subdat_non)
```

```{r}
# Merge tables
table_s3 <-
  tbl_merge(
    tbls = list(
      table_sens_outlier_uv_dm,
      table_sens_outlier_mv_dm,
      table_sens_outlier_uv_non,
      table_sens_outlier_mv_non
    )
  ) |>
  modify_spanning_header(
    list(
      c(estimate_1:p.value_2) ~ "**Patients with T2DM** (N = {paste(counts.dm)})",
      c(estimate_3:p.value_4) ~ "**Patients without T2DM** (N = {paste(counts.non)})"
    )
  ) |>
  modify_footnote(everything() ~ NA, abbreviation = TRUE) |>
  modify_footnote(
    c(estimate_1, estimate_2, estimate_3, estimate_4) ~ "OR = Odds Ratio",
    c(ci_1, ci_2, ci_3, ci_4) ~ "95% CI = 95% Confidence Interval"
  ) |>
  modify_caption("Table S3. Sensitivity to outliers and influential observations")

# Convert gtsummary object to a flextable object and format character columns
flex_table_s3 <- table_s3 |>
  gtsummary::as_flex_table() |>
  my_flextable_theme() |>
  flextable::fontsize(part = "all", size = 10) |>
  ftExtra::colformat_md()

# View
flex_table_s3
```

::: {style="text-align: justify"}
Regarding the sensitivity analysis, on one hand, the sensitivity to the categorization of continuous data showed results similar to those in the main analysis, except for dyspnea and neutrophil count. Dyspnea reached statistical significance in multivariable regression analysis in patients with T2DM, and the neutrophil count in patients without T2DM (Supplementary Table 2). On the other hand, the sensitivity analysis to outliers and influential observations also showed similar results. Specifically, hypertension and heart rate reached statistical significance in multivariable regression analysis in patients with T2DM, while dyspnea and neutrophil count reached statistical significance in patients without T2DM. All other variables kept the same (Supplementary Table 2). While we still should focus on effect sizes rather than p-values, some of these changes are notably large.
:::

# Concordance statistic

```{r}
# T2DM model
survival::concordance(final_model_dm)
```

```{r}
# T2DM sensitivity model
survival::concordance(sens_model_dm)
```

```{r}
# Non-T2DM model
survival::concordance(final_model_non)
# epiDisplay::lroc(final_model_non)$auc
```

```{r}
# Non-T2DM sensitivity model
survival::concordance(sens_model_non)
```

::: {style="text-align: justify"}
The concordance statistic was 0.78 for T2DM model and 0.77 for non-T2DM model. Sensibility analysis showed a value of 0.81 and 0.80 for T2DM model and non-T2DM model, respectively.
:::

# Goodness-of-fit (GOF)

## Hosmer-Lemeshow test

```{r}
# Original model (final) of T2DM patients
ResourceSelection::hoslem.test(final_model_dm$y, final_model_dm$fitted.values)

# Original model (final) of non-T2DM patients
ResourceSelection::hoslem.test(final_model_non$y, final_model_non$fitted.values)
```
::: {style="text-align: justify"}
The p-value of the Hosmer-Lemeshow GOF test for both models indicates that the null hypothesis of a perfect fit is not rejected, and we conclude that the fit is adequate.
:::

## Calibration plot

```{r, fig.align='center'}
# Original model (final) of T2DM patients
calibration.plot(final_model_dm, show.bins = TRUE, show.points = TRUE)
```

```{r, fig.align='center'}
# Original model (final) of non-T2DM patients
calibration.plot(final_model_non, show.bins = TRUE,show.points = TRUE)
```

::: {style="text-align: justify"}
The calibration plot corroborates the conclusion of the Hosmer-Lemeshow test. However, the confidence intervals overlap the continuous diagonal line due to the wide range of values and some triangles are situated far from the continuous diagonal line for the model in patients with T2DM. This phenomenon is not observed in the model for patients without T2DM, which has a larger sample size. Therefore, the fit is more adequate for the model in patients without T2DM than in patients with T2DM. 
:::

# Dimensional reduction

::: {style="text-align: justify"}
Principal Component Analysis (PCA) is an excellent technique for reducing data complexity **before** applying other analytical methods, such as linear regression, k-means clustering, and random forest classification. Integrating PCA with other methods enhances data analysis, model building, and interpretation, resulting in more accurate and efficient results. The choice between PCA and factor analysis depends on the objectives of the analysis.
:::

## Principal Component Analysis (PCA)

::: {style="text-align: justify"}
The PCA is a statistical technique that reduces the dimensionality of a dataset. This process transforms high-dimensional (complex or large) data sets into simpler (smaller) data sets while preserving important information. It helps to remove noise and redundancy from the data set, making the true patterns more pronounced and easier to analyze. With fewer dimensions, it's possible to visually explore and understand complex data sets, focusing on the most relevant features. By identifying the principal components, it's possible to focus on the most influential variables or individuals driving the trends and patterns in the data. This significantly reduces the complexity of interpreting data and makes it easier to explore and visualize. The output of PCA includes the variance explained by each principal component, which helps to understand the importance of each component in the analysis. This is crucial for making informed decisions based on the data. Furthermore, this process is crucial for more effectively analyzing data. The application of PCA can facilitate the acceleration of learning algorithms employed in data analysis, thereby enabling a more efficient and faster process. A reduction in data volume will result in a decrease in the storage and computational resources required. PCA is not merely a mathematical technique; it's a strategic approach to dealing with data in the most efficient way possible.
:::

> üìù***NOTE:*** PCA only works with numerical values.

```{r}
# Patients with T2DM
old_dim.dm <- PCA_data_select(data_match, t2dm, "yes")
```

```{r}
# Patients without T2DM
old_dim.non <- PCA_data_select(data_match, t2dm, "no")
```

::: {style="text-align: justify"}
The first step is to utilize the `prcomp()` function from the `stats` package to perform PCA, with the parameters **centered** and **scaled**. This function is robust and offers a standardized method to perform PCA with ease, providing the user with the principal components, variance captured, and more. The next step is to examine the summary with the `summary()` or `get_eigenvalue()` functions. This will allow you to understand the proportion of variance represented in each principal component and determine which variables contribute the most to them. This information allows us to evaluate the importance and contribution of each principal component.
:::

> üìù***NOTE:*** The eigenvalues represent the variance explained by each principal component.

::: {style="text-align: justify"}
Explore the mathematical concepts of eigenvalues and eigenvectors. Eigenvalues measure the variance captured by each principal component. A higher eigenvalue indicates that the component accounts for a greater proportion of the variance in the data set. This allows for the determination of which principal components are worth keeping for analysis. Eigenvectors, on the other hand, define the direction of the principal components, which are formed by the combination of the original variables. In addition, eigenvectors are perpendicular (orthogonal) to each other, representing a new axis in data space that is aligned with the maximum variance. This orthogonal property ensures that the principal components are independent of each other. The eigenvalues and eigenvectors operate in tandem within PCA to transform and simplify the data set. By identifying new axes (eigenvectors) that maximize variance (eigenvalues), PCA allows the data to be viewed from a different perspective, focusing on the most informative aspects.
:::

## Perform PCA and analyze the eigenvalues/variances

```{r}
# Scaled (standardization) for patients with T2DM
new_dim.dm <- stats::prcomp(old_dim.dm[1:14], scale. = TRUE, center = TRUE)
```

```{r}
# Scaled (standardization) for patients without T2DM
new_dim.non <- stats::prcomp(old_dim.non[1:14], scale. = TRUE, center = TRUE)
```

```{r}
# Extract the eigenvalues of the new dimensions of patients with T2DM
factoextra::get_eigenvalue(new_dim.dm) |>
  mutate(across(where(is.numeric), round, 2))
```

```{r}
# Extract the eigenvalues of the new dimensions of patients without T2DM
factoextra::get_eigenvalue(new_dim.non) |>
  mutate(across(where(is.numeric), round, 2))
```

::: {style="text-align: justify"}
To visualize the PCA, the `ggplot2` and `factoextra` packages can be utilized. Plots such as scree plots can be used to understand the variance explained (eigenvalues) by each component or biplots to understand the relationship between variables and components and how the data is distributed across these new dimensions (principal components). This helps to reveal patterns and clusters. A scree plot assesses the contribution of each component to the total variance. It determines the optimal number of principal components to keep, streamlines the analysis by focusing on the most important components.
:::

```{r fig.height=7, fig.width=8, fig.align='center'}
# Plot variances of new dimensions of patients with T2DM
fviz_eig(
  new_dim.dm,
  addlabels = TRUE,
  choice = "variance",
  barfill = "#99CC00FF",
  barcolor = "#99CC00FF",
  xlab = "New dimensions of patients with T2DM",
  ggtheme = theme_539()
  )
```

```{r fig.height=7, fig.width=8, fig.align='center'}
# Plot variances of new dimensions of patients without T2DM
fviz_eig(
  new_dim.non,
  addlabels = TRUE,
  choice = "variance",
  barfill = "#99CC00FF",
  barcolor = "#99CC00FF",
  xlab = "New dimensions of patients without T2DM",
  ggtheme = theme_539()
  )  
```

### Variables for patients with T2DM

```{r}
# Extract the results for the variables
var.dm <- get_pca_var(new_dim.dm)

# Coordinates for the variables
head(var.dm$coor[order(var.dm$cor[, 1], decreasing = TRUE),], 5)

# Correlations between variables and dimensions
head(var.dm$cor[order(var.dm$cor[, 1], decreasing = TRUE),], 5)

# Quality of representation (Cos2) for the variables on the dimensions
head(var.dm$cos2[order(var.dm$cor[, 1], decreasing = TRUE),], 5)
```

```{r fig.height=7, fig.width=7, fig.align='center'}
# Correlation matrix - Cos2 for the variables
my_ggcorrplor(var.dm$cos2)
```

```{r fig.height=9, fig.width=10, fig.align='center'}
# Cos2 plot of the top 10 variables in the dimension 1
x1 <- fviz_cos2(
  new_dim.dm,
  choice = "var",
  axes = 1,
  top = 10,
  ggtheme = theme_540()
)

# Cos2 plot of the top 10 variables in the dimension 2
x2 <- fviz_cos2(
  new_dim.dm,
  choice = "var",
  axes = 2,
  top = 10,
  ggtheme = theme_540()
)

# Cos2 plot of the top 10 variables in the dimension 3
x3 <- fviz_cos2(
  new_dim.dm,
  choice = "var",
  axes = 3,
  top = 10,
  ggtheme = theme_540()
)

# Cos2 plot of the top 10 variables in the dimension 4
x4 <- fviz_cos2(
  new_dim.dm,
  choice = "var",
  axes = 4,
  top = 10,
  ggtheme = theme_540()
)

# Arrange multiple plots
cos2_plot <- ggpubr::ggarrange(x1, x2, x3, x4,
                               ncol = 2, nrow = 2)

annotate_figure(
  cos2_plot,
  top = text_grob(
    "Cos2 in patients with T2DM",
    face = "bold",
    family = "Lato",
    size = 16)
  ) + 
  ggplot2::theme(plot.background = element_rect(fill = "#f0f0f0", color = NA))
```

```{r}
# Plot of the 10 variables with the highest cos2 in PC1 and PC2
a <- fviz_cos2(
  new_dim.dm,
  choice = "var",
  axes = 1:2,
  top = 10,
  ggtheme = theme_540()
)

# Plot of the 10 variables with the highest cos2 in PC3 and PC4
b <- fviz_cos2(
  new_dim.dm,
  choice = "var",
  axes = 3:4,
  top = 10,
  ggtheme = theme_540()
)

# Correlations circle and color by cos2 values
c <- fviz_pca_var(
  new_dim.dm,
  col.var.dm = "cos2",
  gradient.cols = c("#fee0d2", "#fc9272", "#de2d26"),
  repel = TRUE,
  # repel = TRUE avoid text overlapping
  ggtheme = theme_540()
) 
```

```{r}
# Contributions of the variables on the dimensions
head(var.dm$contrib[order(var.dm$cor[, 1], decreasing = TRUE),], 5)
```

```{r fig.height=7, fig.width=7, fig.align='center'}
# Correlation matrix - contributions of the variables
corrplot(var.dm$contrib, is.corr = FALSE)
```

```{r fig.height=8, fig.width=10, fig.align='center'}
# Contribution plot of the top 10 variables in the dimension 1
y1 <- fviz_contrib(
  new_dim.dm,
  choice = "var",
  axes = 1,
  top = 10,
  ggtheme = theme_540()
)

# Contribution plot of the top 10 variables on PC2
y2 <- fviz_contrib(
  new_dim.dm,
  choice = "var",
  axes = 2,
  top = 10,
  ggtheme = theme_540()
)

# Contribution plot of the top 10 variables on PC3
y3 <- fviz_contrib(
  new_dim.dm,
  choice = "var",
  axes = 3,
  top = 10,
  ggtheme = theme_540()
)

# Contribution plot of the top 10 variables on PC4
y4 <- fviz_contrib(
  new_dim.dm,
  choice = "var",
  axes = 4,
  top = 10,
  ggtheme = theme_540()
)

# Arrange multiple plots
contrib_plot <- ggpubr::ggarrange(
  y1, y2, y3, y4, ncol = 2, nrow = 2)

annotate_figure(
  contrib_plot,
  top = text_grob(
    "Contribution in patients with T2DM",
    face = "bold",
    family = "Lato",
    size = 16)
  ) +
  ggplot2::theme(plot.background = element_rect(fill = "#f0f0f0", color = NA))
```

```{r}
# Plot of 10 variables with the highest contribution on PC1 and PC2
d <- fviz_contrib(
  new_dim.dm,
  choice = "var",
  axes = 1:2,
  top = 10,
  ggtheme = theme_540()
)

# Plot of 10 variables with the highest contribution on PC3 and PC4
e <- fviz_contrib(
  new_dim.dm,
  choice = "var",
  axes = 3:4,
  top = 10,
  ggtheme = theme_540()
)

# Correlations circle and color by contributions values
f <- fviz_pca_var(
  new_dim.dm,
  col.var.dm = "contrib",
  gradient.cols = c("#fee0d2", "#fc9272", "#de2d26"),
  repel = TRUE,
  ggtheme = theme_540()
)
```

```{r fig.height=12, fig.width=12, fig.align='center'}
# Arrange multiple plots
pca_dm <- ggpubr::ggarrange(
  a, d, b, e, c, f,
  ncol = 2, nrow = 3,
  legend = "right"
  )

annotate_figure(
  pca_dm,
  top = text_grob(
    "PCA in patients with T2DM",
    face = "bold",
    family = "Lato",
    size = 16)
  ) + 
  ggplot2::theme(plot.background = element_rect(fill = "#f0f0f0", color = NA))
```

### Variables for patients without T2DM

```{r}
# Extract the results for the variables
var.non <- get_pca_var(new_dim.non)

# Coordinates for the variables
head(var.non$coor[order(var.non$cor[, 1], decreasing = TRUE),], 5)

# Correlations between variables and dimensions
head(var.non$cor[order(var.non$cor[, 1], decreasing = TRUE),], 7)

# Quality of representation (Cos2) for the variables on the dimensions
head(var.non$cos2[order(var.non$cor[, 1], decreasing = TRUE),], 7)
```

```{r fig.height=7, fig.width=7, fig.align='center'}
# Correlation matrix - Cos2 for the variables
my_ggcorrplor(var.non$cos2)
```

```{r fig.height=8, fig.width=10, fig.align='center'}
# Cos2 plot of the top 10 variables in the dimension 1
x5 <- fviz_cos2(
  new_dim.non,
  choice = "var",
  axes = 1,
  top = 10,
  ggtheme = theme_540()
)

# Cos2 plot of the top 10 variables in the dimension 2
x6 <- fviz_cos2(
  new_dim.non,
  choice = "var",
  axes = 2,
  top = 10,
  ggtheme = theme_540()
)

# Cos2 plot of the top 10 variables in the dimension 3
x7 <- fviz_cos2(
  new_dim.non,
  choice = "var",
  axes = 3,
  top = 10,
  ggtheme = theme_540()
)

# Cos2 plot of the top 10 variables in the dimension 4
x8 <- fviz_cos2(
  new_dim.non,
  choice = "var",
  axes = 4,
  top = 10,
  ggtheme = theme_540()
)

# Arrange multiple plots
contrib_plot <- ggpubr::ggarrange(
  x5, x6, x7, x8, ncol = 2, nrow = 2)

annotate_figure(
  contrib_plot,
  top = text_grob(
    "Cos2 in patients without T2DM",
    face = "bold",
    family = "Lato",
    size = 16)
  ) + 
  ggplot2::theme(plot.background = element_rect(fill = "#f0f0f0", color = NA))
```

```{r}
# Plot of 10 variables with highest cos2 on PC1 and PC2
a <- fviz_cos2(
  new_dim.non,
  choice = "var",
  axes = 1:2,
  top = 10,
  ggtheme = theme_540()
)

# Plot of 10 variables with highest cos2 on PC3 and PC4
b <- fviz_cos2(
  new_dim.non,
  choice = "var",
  axes = 3:4,
  top = 10,
  ggtheme = theme_540()
)

# Correlations circle and color by cos2 values
c <- fviz_pca_var(
  new_dim.non,
  col.var.non = "cos2",
  gradient.cols = c("#fee0d2", "#fc9272", "#de2d26"),
  repel = TRUE,
  ggtheme = theme_540()
)
```

```{r}
# Contributions of the variables on the dimensions
head(var.non$contrib[order(var.non$cor[, 1], decreasing = TRUE),], 7)
```

```{r fig.height=7, fig.width=7, fig.align='center'}
# Correlation matrix - contributions of the variables
corrplot(var.non$contrib, is.corr = FALSE)
```

```{r fig.height=8, fig.width=10, fig.align='center'}
# Contribution plot of the top 10 variables on PC1
y5 <- fviz_contrib(
  new_dim.non,
  choice = "var",
  axes = 1,
  top = 10,
  ggtheme = theme_540()
)

# Contribution plot of the top 10 variables on PC2
y6 <- fviz_contrib(
  new_dim.non,
  choice = "var",
  axes = 2,
  top = 10,
  ggtheme = theme_540()
)

# Contribution plot of the top 10 variables on PC3
y7 <- fviz_contrib(
  new_dim.non,
  choice = "var",
  axes = 3,
  top = 10,
  ggtheme = theme_540()
)

# Contribution plot of the top 10 variables on PC4
y8 <- fviz_contrib(
  new_dim.non,
  choice = "var",
  axes = 4,
  top = 10,
  ggtheme = theme_540()
)

# Arrange multiple plots
contrib_plot <- ggpubr::ggarrange(y5, y6, y7, y8,
                                  ncol = 2, nrow = 2)

annotate_figure(
  contrib_plot,
  top = text_grob(
    "Contribution in patients without T2DM",
    face = "bold",
    family = "Lato",
    size = 16)
  ) + 
  ggplot2::theme(plot.background = element_rect(fill = "#f0f0f0", color = NA))
```

```{r}
# Plot of 10 variables with the highest contribution on PC1 and PC2
d <- fviz_contrib(
  new_dim.non,
  choice = "var",
  axes = 1:2,
  top = 10,
  ggtheme = theme_540()
)

# Plot of 10 variables with the highest contribution on PC3 and PC4
e <- fviz_contrib(
  new_dim.non,
  choice = "var",
  axes = 3:4,
  top = 10,
  ggtheme = theme_540()
)

# Correlations circle and color by contributions values
f <- fviz_pca_var(
  new_dim.dm,
  col.var.dm = "contrib",
  gradient.cols = c("#fee0d2", "#fc9272", "#de2d26"),
  repel = TRUE,
  ggtheme = theme_540()
)
```

```{r fig.height=12, fig.width=12, fig.align='center'}
# Arrange multiple plots
pca_non <- ggpubr::ggarrange(
  a, d, b, e, c, f,
  ncol = 2, nrow = 3,
  legend = "right")

annotate_figure(
  pca_non, 
  top = text_grob(
    "PCA in patients without T2DM",
    face = "bold",
    family = "Lato",
    size = 16)
  ) + 
  ggplot2::theme(plot.background = element_rect(fill = "#f0f0f0", color = NA))
```

### Individuals with T2M

```{r results='hide', fig.height=10, fig.width=10, fig.align='center'}
# Extract results for the individuals
ind <- get_pca_ind(new_dim.dm)

# Coordinates for the individuals
head(ind$coord[order(var.dm$cor[, 1], decreasing = TRUE),], 5)

# Cos2 of the individuals on dimensions
head(ind$cos2[order(var.dm$cor[, 1], decreasing = TRUE),], 5)
```

```{r}
# Plot of 20 patients with the highest cos2 in PC1 and PC2
a <- fviz_cos2(
  new_dim.dm,
  choice = "ind",
  axes = 1:2,
  top = 20,
  ggtheme = theme_540()
)

# Plot of 20 patients with the highest cos2 in PC3 and PC4
b <- fviz_cos2(
  new_dim.dm,
  choice = "ind",
  axes = 3:4,
  top = 20,
  ggtheme = theme_540()
)

# Correlations circle and color by cos2 values
c <- fviz_pca_ind(
  new_dim.dm,
  col.ind = "cos2",
  gradient.cols = c("#fee0d2", "#fc9272", "#de2d26"),
  repel = TRUE,
  ggtheme = theme_540()
)
```

```{r}
# Contributions of the individuals on dimensions
head(ind$contrib[order(var.dm$cor[, 1], decreasing = TRUE),], 5)
```

```{r}
# Plot of the 20 individuals with the highest contribution in PC1 and PC2
d <- fviz_contrib(
  new_dim.dm,
  choice = "ind",
  axes = 1:2,
  top = 20,
  ggtheme = theme_540()
)

# Plot of the 20 individuals with the highest contribution in PC3 and PC4
e <- fviz_contrib(
  new_dim.dm,
  choice = "ind",
  axes = 3:4,
  top = 20,
  ggtheme = theme_540()
)

# Correlations circle and color by contributions values
f <- fviz_pca_ind(
  new_dim.dm,
  col.ind = "contrib",
  gradient.cols = c("#fee0d2", "#fc9272", "#de2d26"),
  ggtheme = theme_540()
)
```

```{r fig.height=12, fig.width=12, fig.align='center'}
# Arrange multiple plots
pca_ind.dm <- ggpubr::ggarrange(
  a, d, b, e, c, f, ncol = 2, nrow = 3, 
  legend = "right")

annotate_figure(
  pca_ind.dm,
  top = text_grob(
    "Patients with T2DM",
    face = "bold",
    family = "Lato",
    size = 16)
  ) +
  ggplot2::theme(plot.background = element_rect(fill = "#f0f0f0", color = NA))
```

```{r}
# Plot of individuals and color by outcome on PC1 and PC2
ind_plot.dm_1 <- fviz_pca_ind(
  new_dim.dm,
  axes = 1:2,
  geom.ind = "point",
  col.ind = old_dim.dm$outcome,
  addEllipses = TRUE,
  mean.point = FALSE,
  labelsize = 8,
  pointsize = 4,
  palette = c("#C03728", "#919C4C"),
  ggtheme = theme_pomological(base_family = "Homemade Apple", base_size = 30)
)

a <- ggpubr::ggpar(
  ind_plot.dm_1,
  title = element_blank(),
  xlab = "PC1 (22.8%)",
  ylab = "PC2 (12.2%)",
  legend.title = "Group",
  legend = "right",
  font.legend = c(30, "black")
  )

# Plot of individuals and color by outcome on PC3 and PC4
ind_plot.dm_2 <- fviz_pca_ind(
  new_dim.dm,
  axes = 3:4,
  geom.ind = "point",
  col.ind = old_dim.dm$outcome,
  addEllipses = TRUE,
  mean.point = FALSE,
  labelsize = 8,
  pointsize = 4,
  palette = c("#C03728", "#919C4C"),
  ggtheme = theme_pomological(base_family = "Homemade Apple", base_size = 30)
  )

b <- ggpubr::ggpar(
  ind_plot.dm_2,
  title = element_blank(),
  xlab = "PC3 (11.5%)",
  ylab = "PC2 (9.9%)",
  legend.title = "Group",
  legend = "right",
  font.legend = c(30, "black")
  )
```

```{r fig.height=10, fig.width=24, fig.align='center'}
# Arrange multiple plots
ind_plot_dm <- ggpubr::ggarrange(
  a, b,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Homemade Apple", size = 30)) + 
  ggplot2::theme(panel.background = element_rect(fill = "#FFFEEA", color = NA))

# View
ind_plot_dm
```

### Individuals without T2M

```{r results='hide', fig.height=10, fig.width=10, fig.align='center'}
# Extract results for the individuals
ind <- get_pca_ind(new_dim.non)

# Coordinates for the individuals
head(ind$coord[order(var.non$cor[, 1], decreasing = TRUE),], 5)

# Cos2 of the individuals on dimensions
head(ind$cos2[order(var.non$cor[, 1], decreasing = TRUE),], 5)
```

```{r}
# Plot of 20 patients with the highest cos2 in PC1 and PC2
a <- fviz_cos2(
  new_dim.non,
  choice = "ind",
  axes = 1:2,
  top = 20,
  ggtheme = theme_540()
)

# Plot of 20 patients with the highest cos2 in PC3 and PC4
b <- fviz_cos2(
  new_dim.non,
  choice = "ind",
  axes = 3:4,
  top = 20,
  ggtheme = theme_540()
)

# Correlations circle and color by cos2 values
c <- fviz_pca_ind(
  new_dim.non,
  col.ind = "cos2",
  gradient.cols = c("#fee0d2", "#fc9272", "#de2d26"),
  repel = TRUE,
  ggtheme = theme_540()
)
```

```{r}
# Contributions of the individuals on dimensions
head(ind$contrib[order(var.non$cor[, 1], decreasing = TRUE),], 5)
```

```{r}
# Plot of the 20 individuals with the highest contribution in PC1 and PC2
d <- fviz_contrib(
  new_dim.non,
  choice = "ind",
  axes = 1:2,
  top = 20,
  ggtheme = theme_540()
)

# Plot of the 20 individuals with the highest contribution in PC3 and PC4
e <- fviz_contrib(
  new_dim.non,
  choice = "ind",
  axes = 3:4,
  top = 20,
  ggtheme = theme_540()
)

# Correlations circle and color by contributions values
f <- fviz_pca_ind(
  new_dim.non,
  col.ind = "contrib",
  gradient.cols = c("#fee0d2", "#fc9272", "#de2d26"),
  ggtheme = theme_540()
)
```

```{r fig.height=12, fig.width=12, fig.align='center'}
# Arrange multiple plots
pca_ind.dm <- ggpubr::ggarrange(
  a, d, b, e, c, f, ncol = 2, nrow = 3, 
  legend = "right")

annotate_figure(
  pca_ind.dm,
  top = text_grob(
    "Patients without T2DM",
    face = "bold",
    family = "Lato",
    size = 16)
  ) +
  ggplot2::theme(plot.background = element_rect(fill = "#f0f0f0", color = NA))
```

```{r}
# Plot of individuals and color by outcome on PC1 and PC2
ind_plot.non_1 <- fviz_pca_ind(
  new_dim.non,
  axes = 1:2,
  geom.ind = "point",
  col.ind = old_dim.non$outcome,
  addEllipses = TRUE,
  mean.point = FALSE,
  labelsize = 8,
  pointsize = 4,
  palette = c("#C03728", "#919C4C"),
  ggtheme = theme_pomological(base_family = "Homemade Apple", base_size = 30)
)

a <- ggpubr::ggpar(
  ind_plot.non_1,
  title = element_blank(),
  xlab = "PC1 (22%)",
  ylab = "PC2 (12.3%)",
  legend.title = "Group",
  legend = "right",
  font.legend = c(30, "#272822")
  )

# Plot of individuals and color by outcome on PC3 and PC4
ind_plot.non_2 <- fviz_pca_ind(
  new_dim.non,
  axes = 3:4,
  geom.ind = "point",
  col.ind = old_dim.non$outcome,
  addEllipses = TRUE,
  mean.point = FALSE,
  labelsize = 8,
  pointsize = 4,
  palette = c("#C03728", "#919C4C"),
  ggtheme = theme_pomological(base_family = "Homemade Apple", base_size = 30)
)

b <- ggpubr::ggpar(
  ind_plot.non_2,
  title = element_blank(),
  xlab = "PC3 (10.8%)",
  ylab = "PC2 (10%)",
  legend.title = "Group",
  legend = "right",
  font.legend = c(30, "#272822")
)
```

```{r fig.height=10, fig.width=24, fig.align='center'}
# Arrange multiple plots
ind_plot_non <-ggpubr::ggarrange(
  a, b,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Homemade Apple", size = 30)) + 
  ggplot2::theme(panel.background = element_rect(fill = "#FFFEEA", color = NA))

# View
ind_plot_non
```

### Biplot of individuals and variables of patients with T2DM

```{r}
# Contributions on PC1 and PC2
a.dm <- fviz_pca_biplot(
  new_dim.dm,
  # Dimensions 1 and 2
  axes = 1:2,
  # Individuals
  col.ind = old_dim.dm$outcome,
  geom.ind = "point",
  col.var = "#272822",
  # Top 10 contributing variables
  geom.var = "text",
  select.var = list(contrib = 10),
  # Theme
  palette = c("#2A6EBBFF", "#F0AB00FF"),
  addEllipses = TRUE,
  mean.point = FALSE,
  repel = TRUE,
  labelsize = 8,
  pointsize = 4,
  ggtheme = theme_541()
)

# Plot parameters
a1.dm <- ggpubr::ggpar(
  a.dm,
  title = element_blank(),
  xlab = "PC1 (22.8%)",
  ylab = "PC2 (12.2%)",
  legend.title = "Group ",
  font.legend = c(30, "#272822")
)

# Contributions on PC1 and PC3
b.dm <- fviz_pca_biplot(
  new_dim.dm,
  # Dimensions 1 and 3
  axes = c(1, 3),
  # Individuals
  col.ind = old_dim.dm$outcome,
  geom.ind = "point",
  col.var = "#272822",
  # Top 10 contributing variables
  geom.var = "text",
  select.var = list(contrib = 10),
  # Theme
  palette = c("#2A6EBBFF", "#F0AB00FF"),
  addEllipses = TRUE,
  mean.point = FALSE,
  repel = TRUE,
  labelsize = 8,
  pointsize = 4,
  ggtheme = theme_541()
)

# Plot parameters
b1.dm <- ggpubr::ggpar(
  b.dm,
  title = element_blank(),
  xlab = "PC1 (22.8%)",
  ylab = "PC3 (11.5%)",
  legend.title = "Group ",
  font.legend = c(30, "#272822")
)
```

```{r fig.height=10, fig.width=24, fig.align='center'}
# Arrange multiple plots
F1_dm <- ggpubr::ggarrange(
  a1.dm, b1.dm,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Lato", size = 30)) + 
  ggplot2::theme(plot.background = element_rect(fill = "#FFFFFF", color = NA))

# View
F1_dm
```

```{r, echo=FALSE}
# Contributions on PC1 and PC2
a.dm_gray <- fviz_pca_biplot(
  new_dim.dm,
  # Dimensions 1 and 2
  axes = 1:2,
  # Individuals
  col.ind = old_dim.dm$outcome,
  geom.ind = "point",
  col.var = "black",
  # Top 10 contributing variables
  geom.var = "text",
  select.var = list(contrib = 10),
  # Theme
  addEllipses = TRUE,
  mean.point = FALSE,
  repel = TRUE,
  labelsize = 8,
  pointsize = 4,
  ggtheme = theme_541()
) +
  ggplot2::scale_color_manual(values = c("grey14", "grey59")) +
  ggplot2::scale_fill_manual(values = c("grey14", "grey59"))

# Plot parameters
a1.dm_gray <- ggpubr::ggpar(
  a.dm_gray,
  title = element_blank(),
  xlab = "PC1 (22%)",
  ylab = "PC2 (12.3%)",
  legend.title = "Group ",
  font.legend = c(30, "black")
)

# Contributions on PC1 and PC3
b.dm_gray <- fviz_pca_biplot(
  new_dim.dm,
  # Dimensions 1 and 3
  axes = c(1, 3),
  # Individuals
  col.ind = old_dim.dm$outcome,
  geom.ind = "point",
  col.var = "black",
  # Top 10 contributing variables
  geom.var = "text",
  select.var = list(contrib = 10),
  # Theme
  addEllipses = TRUE,
  mean.point = FALSE,
  repel = TRUE,
  labelsize = 8,
  pointsize = 4,
  ggtheme = theme_541()
) +
  ggplot2::scale_color_manual(values = c("grey14", "grey59")) +
  ggplot2::scale_fill_manual(values = c("grey14", "grey59"))

# Plot parameters
b1.dm_gray <- ggpubr::ggpar(
  b.dm_gray,
  title = element_blank(),
  xlab = "PC1 (22%)",
  ylab = "PC3 (10.8%)",
  legend.title = "Group ",
  font.legend = c(30, "black")
)
```

```{r fig.height=10, fig.width=24, fig.align='center', echo=FALSE}
# Arrange multiple plots
F1.dm_gray <- ggpubr::ggarrange(
  a1.dm_gray, b1.dm_gray,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Lato", size = 30)) + 
  ggplot2::theme(plot.background = element_rect(fill = "#FFFFFF", color = NA))
```

### Biplot of individuals and variables of patients without T2DM

```{r}
# Contributions on PC1 and PC2
a.non <- fviz_pca_biplot(
  new_dim.non,
  # Dimensions 1 and 2
  axes = 1:2,
  # Individuals
  col.ind = old_dim.non$outcome,
  geom.ind = "point",
  col.var = "#272822",
  # Top 10 contributing variables
  geom.var = "text",
  select.var = list(contrib = 10),
  # Theme
  palette = c("#2A6EBBFF", "#F0AB00FF"),
  addEllipses = TRUE,
  mean.point = FALSE,
  repel = TRUE,
  labelsize = 8,
  pointsize = 4,
  ggtheme = theme_541()
)

# Plot parameters
a1.non <- ggpubr::ggpar(
  a.non,
  title = element_blank(),
  xlab = "PC1 (22%)",
  ylab = "PC2 (12.3%)",
  legend.title = "Group ",
  font.legend = c(30, "#272822")
)

# Contributions on PC1 and PC3
b.non <- fviz_pca_biplot(
  new_dim.non,
  # Dimensions 1 and 3
  axes = c(1, 3),
  # Individuals
  col.ind = old_dim.non$outcome,
  geom.ind = "point",
  col.var = "#272822",
  # Top 10 contributing variables
  geom.var = "text",
  select.var = list(contrib = 10),
  # Theme
  palette = c("#2A6EBBFF", "#F0AB00FF"),
  addEllipses = TRUE,
  mean.point = FALSE,
  repel = TRUE,
  labelsize = 8,
  pointsize = 4,
  ggtheme = theme_541()
)

# Plot parameters
b1.non <- ggpubr::ggpar(
  b.non,
  title = element_blank(),
  xlab = "PC1 (22%)",
  ylab = "PC3 (10.8%)",
  legend.title = "Group ",
  font.legend = c(30, "#272822")
)
```

```{r fig.height=10, fig.width=24, fig.align='center'}
# Arrange multiple plots
F1_non <- ggpubr::ggarrange(
  a1.non, b1.non,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Lato", size = 30)) + 
  ggplot2::theme(plot.background = element_rect(fill = "#FFFFFF", color = NA))

# View
F1_non
```

```{r, echo=FALSE}
# Contributions on PC1 and PC2
a.non_gray <- fviz_pca_biplot(
  new_dim.non,
  # Dimensions 1 and 2
  axes = 1:2,
  # Individuals
  col.ind = old_dim.non$outcome,
  geom.ind = "point",
  col.var = "black",
  # Top 10 contributing variables
  geom.var = "text",
  select.var = list(contrib = 10),
  # Theme
  addEllipses = TRUE,
  mean.point = FALSE,
  repel = TRUE,
  labelsize = 8,
  pointsize = 4,
  ggtheme = theme_541()
) +
  ggplot2::scale_color_manual(values = c("grey14", "grey59")) +
  ggplot2::scale_fill_manual(values = c("grey14", "grey59"))

# Plot parameters
a1.non_gray <- ggpubr::ggpar(
  a.non_gray,
  title = element_blank(),
  xlab = "PC1 (22%)",
  ylab = "PC2 (12.3%)",
  legend.title = "Group ",
  font.legend = c(30, "black")
)

# Contributions on PC1 and PC3
b.non_gray <- fviz_pca_biplot(
  new_dim.non,
  # Dimensions 1 and 3
  axes = c(1, 3),
  # Individuals
  col.ind = old_dim.non$outcome,
  geom.ind = "point",
  col.var = "black",
  # Top 10 contributing variables
  geom.var = "text",
  select.var = list(contrib = 10),
  # Theme
  addEllipses = TRUE,
  mean.point = FALSE,
  repel = TRUE,
  labelsize = 8,
  pointsize = 4,
  ggtheme = theme_541()
) +
  ggplot2::scale_color_manual(values = c("grey14", "grey59")) +
  ggplot2::scale_fill_manual(values = c("grey14", "grey59"))

# Plot parameters
b1.non_gray <- ggpubr::ggpar(
  b.non_gray,
  title = element_blank(),
  xlab = "PC1 (22%)",
  ylab = "PC3 (10.8%)",
  legend.title = "Group ",
  font.legend = c(30, "black")
)
```

```{r fig.height=10, fig.width=24, fig.align='center', echo=FALSE}
# Arrange multiple plots
F1.non_gray <- ggpubr::ggarrange(
  a1.non_gray, b1.non_gray,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Lato", size = 30)) + 
  ggplot2::theme(plot.background = element_rect(fill = "#FFFFFF", color = NA))
```

```{r fig.height=10, fig.width=24, fig.align='center'}
# Arrange multiple plots
F2 <- ggpubr::ggarrange(
  a1.dm, a1.non,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Lato", size = 30)) + 
  ggplot2::theme(plot.background = element_rect(fill = "#FFFFFF", color = NA))

# View
F2
```

```{r fig.height=10, fig.width=24, fig.align='center', echo=TRUE}
# Arrange multiple plots
F2_gray <- ggpubr::ggarrange(
  a1.dm_gray, a1.non_gray,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Lato", size = 30)) + 
  ggplot2::theme(plot.background = element_rect(fill = "#FFFFFF", color = NA))
```

::: {style="text-align: justify"}
Among COVID-19 patients with T2DM, PCA showed that neutrophils, NLR, WBC, and PaO2:FiO2 ratio were that the variables with higher contributions for PC1 (22.8%), while DBP, SBP and SaO2 were that the variables with higher contributions for PC2 (12.2%) but PaO2:FiO2 ratio and SaO2 were important in survivor group (Figure 2A). Also, the biplot of PC1 and PC3 showed similar results including respiratory and hear rates (Figure S2A). Among COVID-19 patients without T2DM, neutrophils, WBC, NLR, PaO~2~:FiO~2~ ratio, and SaO~2~ were that the variables with higher contributions for PC1 (22%),while DBP, SBP, PaO~2~:FiO~2~ ratio, PaO~2~ and NLR were that the variables with higher contributions for PC2 (12.3%) but PaO~2~:FiO~2~ ratio, SaO~2~ abd PaO~2~ were important in survivor group (Figure 2B). Also, the biplot of PC1 and PC3 showed similar results including age (Figure S2B). However, based on the results of bivariate analysis and PCA, the T2DM group showed that SBP, DBP, respiratory rate and platelets was not showed difference significantly by outcome groups, and only SBP, DBP, and platelets was not showed difference significantly by outcome groups in patients without T2DM.
:::

```{r fig.height=10, fig.width=24, fig.align='center'}
# Arrange multiple plots
FS2 <- ggpubr::ggarrange(
  b1.dm, b1.non,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE
  )

# View
FS2
```

```{r fig.height=10, fig.width=24, fig.align='center', echo=FALSE}
# Arrange multiple plots
FS2_gray <- ggpubr::ggarrange(
  b1.dm_gray, b1.non_gray,
  ncol = 2, nrow = 1,
  labels = c("A)", "B)"),
  legend = "bottom",
  common.legend = TRUE,
  font.label = list(family = "Lato", size = 30)) + 
  ggplot2::theme(plot.background = element_rect(fill = "#FFFFFF", color = NA))
```

::: {style="text-align: justify"}
The PCA has limitations, including **sensitivity to the scale of variables**. It's essential to standardize variables to have *unit variance* before conducting PCA to mitigate this issue. PCA also assumes **linearity**; if variables do not exhibit linear relationships, alternative dimensionality reduction methods like t-SNE or UMAP may be more suitable for non-linear data structures. The principal components (new dimensions) created by PCA are linear combinations of the original variables (original dimensions) and may lack direct interpretability, necessitating careful evaluation. Dimension reduction through PCA inevitably leads to some information loss. While the discarded components are less significant, they may still hold valuable insights. Recognizing these limitations is crucial as it does not lessen PCA's value but rather enhances its usefulness in guiding its application. It's recommended to perform PCA before K-means clustering because speeds up the clustering process and optimizes computational resources, especially on large datasets. The PCA optimizes clustering by reducing noise and redundant information, which helps K-means clustering focus on relevant features, leading to more accurate cluster assignments. Dimension reduction captures important information into few dimensions, this reduces the number of features and preserves most of the variation, making subsequent clustering more efficient and improves interpretation.
:::

## t-Distributed Stochastic Neighbor Embedding (t-SNE)

### t-SNE of patients with T2DM

```{r fig.align='center'}
tsne_data.dm <- old_dim.dm |>
  dplyr::mutate(ID = row_number())

meta_numerical <- tsne_data.dm |>
  dplyr::select(ID, outcome)

tSNE_fit <- tsne_data.dm |>
  dplyr::select(where(is.numeric)) |>
  scale() |>
  Rtsne()

tSNE_df <- tSNE_fit$Y |>
  as.data.frame() |>
  rename(tSNE1 = "V1",
         tSNE2 = "V2") |>
  mutate(ID = row_number())

tSNE_df <- tSNE_df |>
  inner_join(meta_numerical, by = "ID")

tSNE_df |>
  ggplot(aes(x = tSNE1,
             y = tSNE2,
             color = outcome)) +
  geom_point() +
  labs(color = "Group") +
  scale_color_pomological() +
  theme_pomological_fancy() +
  theme(legend.position = "right")
```

### t-SNE of patients without T2DM

```{r fig.height=5, fig.width=8, fig.align='center'}
tsne_data.non <- old_dim.non |>
  dplyr::mutate(ID = row_number())

meta_numerical <- tsne_data.non |>
  dplyr::select(ID, outcome)

tSNE_fit <- tsne_data.non |>
  dplyr::select(where(is.numeric)) |>
  scale() |>
  Rtsne()

tSNE_df <- tSNE_fit$Y |>
  as.data.frame() |>
  rename(tSNE1 = "V1",
         tSNE2 = "V2") |>
  mutate(ID = row_number())

tSNE_df <- tSNE_df |>
  inner_join(meta_numerical, by = "ID")

tSNE_df |>
  ggplot(aes(x = tSNE1,
             y = tSNE2,
             color = outcome)) +
  geom_point() +
  labs(color = "Group") +
  scale_color_pomological() +
  theme_pomological_fancy() +
  theme(legend.position = "right")
```

# Save outputs

::: {style="text-align: justify"}
Word (`.docx`) and PowerPoint (`*.pptx`) documents can be manipulated with the `officer` package. For example, you can use the `fp_border()` function to define a border style or `prop_section()` to define section properties such as page size, page orientation, borders and margins.
:::

## Tables

::: {style="text-align: justify"}
The `save_as_docx()` function of the `flextable` package can be used in conjunction with the `string` package to set the output directory. This can be achieved by using the following code: `path = stringr::str_glue(output_dir, "table.docx")`, or by using the `here()` function, as demonstrated below.
:::

```{r}
# Save tables
save_as_docx(
  flex_table_1,
  path = here("outputs", "Table_1.docx"),
  align = "center")

save_as_docx(
  flex_table_2,
  path = here("outputs", "Table_2.docx"),
  align = "center")

save_as_docx(
  flex_table_3,
  path = here("outputs", "Table_3.docx"),
  align = "center")

save_as_docx(
  flex_table_4,
  path = here("outputs", "Table_4.docx"),
  align = "center")

save_as_docx(
  flex_table_5,
  path = here("outputs", "Table_5.docx"),
  align = "center")

save_as_docx(
  flex_table_s1,
  path = here("outputs", "Table_s1.docx"),
  align = "center")

save_as_docx(
  flex_table_s2,
  path = here("outputs", "Table_s2.docx"),
  align = "center")

save_as_docx(
  flex_table_s3,
  path = here("outputs", "Table_s3.docx"),
  align = "center")
```

## Figures

::: {style="text-align: justify"}
The `ggsave()` function of the `gpplot2` package can be used in conjunction with the `string` package to set the output directory. This can be achieved by using the following code: `filename = stringr::str_glue(output_dir, "figure_1.png")`, or by using the `here()` function, as demonstrated below. All dimensions are in inches (in).
:::

```{r}
# Save figure 1 (PNG)
ggsave(
  plot = F2,
  filename = here("outputs", "FIG_1.png"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save figure 1 (JPEG)
ggsave(
  plot = F2,
  filename = here("outputs", "FIG_1.jpeg"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save figure 1 grey (PNG)
ggsave(
  plot = F2_gray,
  filename = here("outputs", "FIG_1_gray.png"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save figure 1 grey (JPEG)
ggsave(
  plot = F2_gray,
  filename = here("outputs", "FIG_1_gray.jpeg"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")
```

## Supplementary figure

```{r}
# Save supplementary figure 1 (PNG)
ggsave(
  plot = FS1,
  filename = here("outputs", "FIG_S1.png"),
  width = 9,
  height = 9,
  dpi = 500,
  units = "in")

# Save supplementary figure 1 (JPEG)
ggsave(
  plot = FS1,
  filename = here("outputs", "FIG_S1.jpeg"),
  width = 9,
  height = 9,
  dpi = 500,
  units = "in")

# Save supplementary figure 1 gray (PNG)
ggsave(
  plot = FS1_grey,
  filename = here("outputs", "FIG_S1_gray.png"),
  width = 9,
  height = 9,
  dpi = 500,
  units = "in")

# Save supplementary figure 1 gray (JPEG)
ggsave(
  plot = FS1_grey,
  filename = here("outputs", "FIG_S1_gray.jpeg"),
  width = 9,
  height = 9,
  dpi = 500,
  units = "in")

# Save supplementary figure 2 grey (PNG)
ggsave(
  plot = FS2_gray,
  filename = here("outputs", "FIG_S2_gray.png"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 2 grey (JPEG)
ggsave(
  plot = FS2_gray,
  filename = here("outputs", "FIG_S2_gray.jpeg"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 3 (PNG)
ggsave(
  plot = F1_dm,
  filename = here("outputs", "FIG_S3.png"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 3 (JPEG)
ggsave(
  plot = F1_dm,
  filename = here("outputs", "FIG_S3.jpeg"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 3 grey (PNG)
ggsave(
  plot = F1.dm_gray,
  filename = here("outputs", "FIG_S3_gray.png"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 3 grey (JPEG)
ggsave(
  plot = F1.dm_gray,
  filename = here("outputs", "FIG_S3_gray.jpeg"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 4 (PNG)
ggsave(
  plot = F1_non,
  filename = here("outputs", "FIG_S4.png"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 4 (JPEG)
ggsave(
  plot = F1_non,
  filename = here("outputs", "FIG_S4.jpeg"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 4 gray (PNG)
ggsave(
  plot = F1.non_gray,
  filename = here("outputs", "FIG_S4_gray.png"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")

# Save supplementary figure 4 gray (JPEG)
ggsave(
  plot = F1.non_gray,
  filename = here("outputs", "FIG_S4_gray.jpeg"),
  width = 24,
  height = 10,
  dpi = 300,
  units = "in")
```
